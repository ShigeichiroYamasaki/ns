# ネットワークセキュリティ演習 5回 ファイアーウォールの構築

最終更新 2022/09/19 Shigeichiro yamasaki

##  演習の目的と概要

★★ ループ接続しないように厳重に注意する！

* 班ごとにファイアーウォールルーターを構築
* iptablesによるファイアーウォールを作成する
* ポリシーに沿ったファイアーウォールを定義する
* C言語のポインターについて知る

## 演習の手順

* 1. ネットワーク構造図のとおりに物理的接続を行う
* 2. Linuxマシンをルータにする
* 3. iptabelsを使ったファイアーウォールの構築
* 4. ファイアーウォール・ポリシーの作成
* 5. C言語（ポインター）


## システム構成

ルータマシンは，USBのLANアダプタを使ってLANポートを増やしてハブに接続します．
ルータマシン以外のマシンは，ハブから接続されます．（物理的接続は変更なし）

### ネットワーク構造図

まず，紙に描いてみましょう．

```
    Internet
    (ルータ）
        |192.168.1.1
        |
---+----+--+----+------------------- 192.168.1.0/24（これまでのハブ）
   |       |    |
   |       |    外部PC（webサーバ，smtpサーバ）
   |       |
   |    (FW1) 各班のルータ1
   |       |
   |       | USB-LANアダプタ          DMZ
   |   ----+-----+-----------+------- 192.168.2.0/24 （各班のハブ）
   |       1     2           3  
   |             webサーバ   smtpサーバ
   |                         (sshサーバ）
 (FW2) 各班のルータ2
   |
   | USB-LANアダプタ            内部ネットワーク
 --+----+---------------------- 192.168.2.0/24 （各班のハブ）
   1    10  
        内部PC
```

#### サーバーマシンのIPアドレス

```
webサーバー：192.168.2.2
smtpサーバ：192.168.2.3 （sshサーバとしても利用する予定）
```

#### DNSサーバのIPアドレス

```
8.8.8.8 8.8.4.4
```

## 1 ネットワーク構造図のとおりに物理的接続を行う

強粘着のラベルを配布します．
PCやハブにすでにラベルが貼られている場合は剥がしてください．

* 各班のPCの中からルータを２台決める
* 各班のPCの中から web サーバとsmtpサーバをそれぞれ１台決める
* 各班のPCの中から 外部PCを１台決める
* 各班のPCの中から 内部PCを１台決める
* それぞれにシールを貼る（FW1, FW2, web, smtp, 外部PC，内部PC)

### 1.1 各班にハブを２台ずつ配布

* １台のハブをDMZ用にする
* １台のハブを内部ネットワーク用にする
* それぞれにシールを貼る

###  1.2 USB-LAN アダプタを2個ずつ配布（LANケーブルも）

* 各班のルータ FW1 と FW2 にそれぞれUSB-LANアダプタをUSBに接続
* 各班で，LANケーブルを２本追加配布する（取りに来る）

### 1.3 ネットワーク構成図を良く見て物理的接続を行う

★★ ループ接続しないように厳重に注意する！

####  これまでとLAN接続を変えないもの（紙の図に○をつける）

* 外部PC
* FW1
* FW2

#### これまでのLAN接続をハブから外すもの

* webサーバ
* smtpサーバ
* 内部PC

#### FW1ルータのUSB-LANアダプタ側にDMZ用ハブを接続（接続が完了したら紙の図に○をつける）

* 新しく入手したLANケーブルでUSB-LANアダプタとDMZ用ハブを接続
* ハブに電源が入っていることや loop 検知が ON になっていることも確認

#### DMZ用ハブに web サーバとsmtpサーバを接続（接続が完了したら紙の図にそれぞれ○をつける）

* webサーバ
* smtpサーバ

#### FW2ルータのUSB-LANアダプタ側に内部ネットワーク用ハブを接続（接続が完了したら紙の図に○をつける）

* 新しく入手したLANケーブルでUSB-LANアダプタとDMZ用ハブを接続
* ハブに電源が入っていることや loop 検知が ON になっていることも確認

#### D内部ネットワーク用ハブに 内部PCを接続（接続が完了したら紙の図に○をつける）

* 内部PC


## 2. Linuxマシンをルータにする

### 2.1 ルータマシン（FW1, FW2）に対して IPフォワードの設定

nanoエディターで/etc/sysctl.conf を編集します

```bash
$ sudo nano /etc/sysctl.conf
```

以下の行を探し，# を削除します

```
# net.ipv4.ip_forward=1
```
### 設定の有効化

```bash
$ sudo sysctl -p
```


### 2.2 FW1ルータのUSB-LANアダプタのIPアドレスを設定する

* ubuntu デスクトップの右上の▼の「設定」メニュー
* Wi-Fi が無効化されていることを確認する（他のマシンも）
* 「設定」の「ネットワーク」を選択
* USB Ethernet の設定（歯車）を選択
* 「IPv4」タブを選択
* ラジオボタンの「手動」を選択
* 「アドレス」に各班のルータのUSB-LANアダプタIPアドレスに `192.168.2.1` を設定
* 「ネットマスク」に24を設定
* 「ゲートウェイ」は空のまま
* 「DNS」 に`8.8.8.8 8.8.4.4` を設定
* 「適用（A)」ボタンをクリック
*  USB-LANアダプタを一度使用停止にして利用状態にする

### ターミナルから IP アドレスの設定を確認して，紙の図のFW1の 1 に○をつける

```bash
$ ip a
```

FW1のUSB-LANアダプタのIPアドレスが `192.168.2.1` になっていれば，紙の図のFW1の 1 に○をつける


### DHCPサーバの設定

```bash
$ sudo apt install -y isc-dhcp-server
```

```bash
$ sudo nano /etc/dhcp/dhcpd.conf
```

設定ファイルの最後に以下を追加する．

```
subnet 192.168.2.0 netmask 255.255.255.0 {
    range 192.168.2.10 192.168.2.50;
    option routers 192.168.2.1;
    option domain-name-servers 8.8.8.8;
}
```

### 2.3 FW2 ルータのUSB-LANアダプタのIPアドレスを設定する

* ubuntu デスクトップの右上の▼の「設定」メニュー
* Wi-Fi が無効化されていることを確認する（他のマシンも）
* 「設定」の「ネットワーク」を選択
* USB Ethernet の設定（歯車）を選択
* 「IPv4」タブを選択
* ラジオボタンの「手動」を選択
* 「アドレス」に各班のルータのUSB-LANアダプタIPアドレスに `192.168.3.1` を設定
* 「ネットマスク」に24を設定
* 「ゲートウェイ」は空のまま
* 「DNS」 に`8.8.8.8 8.8.4.4` を設定
* 「適用（A)」ボタンをクリック
*  USB-LANアダプタを一度使用停止にして利用状態にする

### ターミナルから IP アドレスの設定を確認して紙の図のFW2の 1 に○をつける

```bash
$ ip a
```

FW2のUSB-LANアダプタのIPアドレスが `192.168.3.1` になっていれば，紙の図のFW2の 1 に○をつける

### DHCPサーバの設定

```bash
$ sudo apt install -y isc-dhcp-server
```

```bash
$ sudo nano /etc/dhcp/dhcpd.conf
```

設定ファイルの最後に以下を追加する．

```
subnet 192.168.3.0 netmask 255.255.255.0 {
    range 192.168.3.10 192.168.3.50;
    option routers 192.168.3.1;
    option domain-name-servers 8.8.8.8;
}
```

## 3. iptabelsを使ったファイアーウォールの構築


### 3.1 iptables-persistentのインストール

iptabels の設定が再起動で消えずに永続化するためのものです

```bash
sudo apt install iptables-persistent -y
```

[現在の IPv4 ルールを保存しますか？] を聞かれますので、[はい] をクリック
[現在の IPv6 ルールを保存しますか？] を聞かれますので、[はい] をクリック


### iptables のチェーンの確認

```
$ sudo iptables -L

Chain INPUT (policy ACCEPT)bashtarget     prot opt source               destination         

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination  
```


NATテーブルの確認

```bash
$ sudo iptables -t nat -L

Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination       
```

### 3.2 FW1 と FW2 に動的NAT (IPマスカレード)を設定

FW1とFW2 の２台ともに以下のコマンドを実行します．

★ネットワーク・インターフェース名は，インターネット側のLANカードの名前

```bash
$ sudo iptables -t nat -A POSTROUTING -o eno1 -j MASQUERADE
```

IPマスカレードの設定を確認

```bash
$ sudo iptables -t nat -L

Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
MASQUERADE  all  --  anywhere             anywhere  
```

#### IPマスカレードの確認

これで，DMZや内部ネットワークから外側のネットワークが見えるようになっていると思います．

* webサーバ，smtpサーバ，内部PCでブラウザなどで外部のサイトを見てみる


### 3.3 FW1 に静的NAT（SNAT，DNAT)を設定

* webサーバは DNAT
* smtpサーバは DNATとSNATの両方

#### webサーバとsmtpサーバのIPアドレスを固定する

* webサーバのIPアドレス：192.168.2.2
* smtpサーバのIPアドレス：192.168.2.3 (sshサーバも）

手順それぞれのマシンに対して

* ubuntu デスクトップの右上の▼の「設定」メニュー
* 「設定」の「ネットワーク」を選択
* 「IPv4」タブを選択
* ラジオボタンの「手動」を選択
* 「アドレス」に各班のルータのUSB-LANアダプタIPアドレスに web サーバとsmtpサーバのIPアドレスを設定
* 「ネットマスク」に24を設定
* 「ゲートウェイ」は `192.168.2.1`
* 「DNS」 に`8.8.8.8 8.8.4.4` を設定
* 「適用（A)」ボタンをクリック
*  USB-LANアダプタを一度使用停止にして利用状態にする

### FW1 のサーバを停止させる

FW1 ルータマシンのターミナルで実行

```bash
$ sudo service apache2 stop
$ sudo service postfix stop
$ sudo service ssh stop
```

#### 各班のFW1 のインターネット側のIPアドレスを確認してメモする（ここでは，192.168.1.X とします）

```bash
$ ip a
```

#### web のDNAT の定義


* 外部からのルータのIPアドレスとポート番号： `192.168.1.X:80`
* 変換先IPアドレスとポート番号： `192.168.2.2:80`

```bash
$ sudo iptables -t nat -A PREROUTING -i eno1 -p tcp --dport 80 -j DNAT --to-destination 192.168.2.2:80
```


#### smtp のDNAT の定義


* 外部からのルータのIPアドレスとポート番号： `192.168.1.X:25`
* 変換先IPアドレスとポート番号： `192.168.2.3:25`

```bash
$ sudo iptables -t nat -A PREROUTING -i eno1 -p tcp --dport 25 -j DNAT --to-destination 192.168.2.3:25
```

#### ssh のDNAT の定義

* 外部からのルータのIPアドレスとポート番号： `192.168.1.X:22`
* 変換先IPアドレスとポート番号： `192.168.2.3:22`

```bash
$ sudo iptables -t nat -A PREROUTING -i eno1 -p tcp --dport 22 -j DNAT --to-destination 192.168.2.3:22
```

#### smtp のSNAT の定義


* 外部のルータのIPアドレスとポート番号： `192.168.1.X:25`
* 変換先IPアドレスとポート番号： `192.168.2.3:25`

```bash
$ sudo iptables -t nat -A POSTROUTING -o eno1 -p tcp --sport 25 -j SNAT --to-source 192.168.2.3:25
```


#### iptables 設定の確認

```bash
$ sudo iptables -t nat -L
```

```
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         
DNAT       tcp  --  anywhere             anywhere             tcp dpt:http to:192.168.2.2:80
DNAT       tcp  --  anywhere             anywhere             tcp dpt:smtp to:192.168.2.3:25
DNAT       tcp  --  anywhere             anywhere             tcp dpt:ssh to:192.168.2.3:22

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
MASQUERADE  all  --  anywhere             anywhere            
SNAT       tcp  --  anywhere             anywhere             tcp spt:smtp to:192.168.2.3:25
```


## 4. ファイアーウォール・ポリシーの作成

### ネットワーク構成の略称

* 外部ネットワーク：EXT
* 内部ネットワーク：INT
* DMZ：DMZ

### ポリシーの設計

３つのネットワークに対する情報の流れは以下の６通り

* EXT -> DMZ
* DMZ -> EXT
* EXT -> INT
* INT -> EXT
* DMZ -> INT
* INT -> DMZ

#### EXT -> DMZ

許可する流れ

web:80
smtp:25
X(ssh:22) 許可しない

#### DMZ -> EXT

ALL

#### EXT -> INT

なし

#### INT -> EXT

ALL

#### DMZ -> INT

なし

#### INT -> DMZ

web:80
smtp:25
ssh:22 許可する

### FW1ルータの FORWARDチェーンで ssh を制限FW1ルータのターミナルから）

FW2ルータのインターネット側IPアドレスを `192.168.1.Y` とします．
`192.168.1.Y` からの ssh アクセスだけを許可し他からのssh アクセスを拒否する

```bash
$ sudo iptables -A FORWARD -p tcp --dport 22 -s 192.168.1.Y -j ACCEPT
$ sudo iptables -A FORWARD -p tcp --dport 22 -j DROP
```

### FW1ルータ用シェルスクリプトファイルの作成（FW1ルータのターミナルから）

```
cd ~
nano fw1.sh
```

```bash
#!/bin/bash

# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X

# DNAT
sudo iptables -t nat -A PREROUTING -i eno1 -p tcp --dport 80 -j DNAT --to-destination 192.168.2.2:80
sudo iptables -t nat -A PREROUTING -i eno1 -p tcp --dport 25 -j DNAT --to-destination 192.168.2.3:25
sudo iptables -t nat -A PREROUTING -i eno1 -p tcp --dport 22 -j DNAT --to-destination 192.168.2.3:22

# SNAT
sudo iptables -t nat -A POSTROUTING -o eno1 -p tcp --sport 25 -j SNAT --to-source 192.168.2.3:25

# FORWARD
sudo iptables -A FORWARD -p tcp --dport 22 -s 192.168.1.Y -j ACCEPT
sudo iptables -A FORWARD -p tcp --dport 22 -j DROP

# 設定の確認
sudo iptables -L
sudo iptables -t nat -L
```

## 4. C言語（ポインター）

### 実行ファイル名付きでコンパイル

* 実行ファイル名を 'hello' とする

```bash
gcc -o hello hello.c
```

* コンパイルした実行ファイルの実行

```bash
./hello
hello hello hello
```

### 変数宣言の確認


* 整数型の変数aを宣言する

```bash
nano integer.c
```

```c
#include <stdio.h>
int main(void)
{
  int a;
  a=100;
  return 0;
}
```

```bash
gcc integer.c
```

```bash
./a.out
```

### printf文による出力


integer.c

```c
#include <stdio.h>
int main(void)
{
  int a;
  a=100;
  printf("%d",a);
  return 0;
}
```

```bash
gcc integer.c
```

```bash
./a.out
```

### 出力を改行する

integer.c

```c
#include <stdio.h>
int main(void)
{
  int a;
  a=100;
  printf("%d\n",a);
  return 0;
}
```

```bash
gcc integer.c
```

```bash
./a.out
```


### 変数宣言と代入を一度にやる

integer.c

```c
#include <stdio.h>
int main(void)
{
  int a=100;
  printf("%d\n",a);
  return 0;
}
```

```bash
gcc integer.c
```

```bash
./a.out
```

### アドレス演算子を利用して変数のアドレスを得る

```bash
nano address.c
```

```c
#include <stdio.h>
int main()
{
int a=100;
printf("%p\n",&a);
return 0;
}

```

```bash
gcc address.c
```

```bash
./a.out
```

### ポインタと間接演算子

```bash
nano pointer.c
```


```c
#include <stdio.h>
int main()
{
  int a = 100;
  int *p;
  p = &a;  /* ポインタpに変数aのアドレスを代入する*/
  printf("%d\n", *p);
  return 0;
}
```

```bash
gcc pointer.c
```

```bash
./a.out
```


### ポインタ変数が指すオブジェクトの変更


 pointer.c
 
 ```c
 #include <stdio.h>
int main(){
    int a = 100;
    int b = 500;
    int *p;
    p = &a;
    printf("%d\n", *p);
    p = &b;
    printf("%d\n", *p);
    return 0;
}

 ```


### コマンドライン引数

```bash
nano kodama.c
```


```c
#include <stdio.h>
int main(int argc, char *argv[])
{
  puts(argv[1]);
  return 0;
}
```

* コンパイル

```bash
gcc -o kodama kodama.c
```

* 実行


```bash
./kodama hello
```

### C言語の配列


array.c

```c
#include <stdio.h>
int main(){
  int a[3];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a[0]=%d,a[1]=%d,a[2]=%d\n",a[0],a[1],a[2]);
  return 0;
}

```

### ポインタとしての配列

```c
#include <stdio.h>
int main(){
  int a[3];
  int *p;
  p=&a[0];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("*p=%d\n",*p);
  return 0;
}
```

### 配列変数はポインタ変数

```c
#include <stdio.h>
int main(){
  int a[3];
  int *p;
  p=a;
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("*p=%d\n",*p);
  return 0;
}

```

### C言語の文字列は文字の配列

```c
#include <stdio.h>
int main(){
  char *aisatu;
  aisatu="hello";
  puts(aisatu);
  return 0;
}

```

### コマンドライン引数の配列

```c
#include <stdio.h>
int main(int argc, char *argv[]){
  printf("argc: %d\n",argc);
  for(int i=0; i<argc ; ++i){
    printf("argv: %s\n",argv[i]);
  }
}

```

### ポインタのポインタ

```c
#include <stdio.h>
int main(void){
    int a = 0;
    int *p;   /*整数へのポインタ*/
    int **pp; /*整数へのポインタのポインタ*/
    p=&a;
    pp=&p;
    printf("**pp=%d\n", **pp);
    return 0;
}

```

