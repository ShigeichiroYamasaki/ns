# ネットワークセキュリティ演習
## 5回 ファイアーウォールの構築

後の回の授業で，ゼロトラスト・ネットワークの概念を説明します。

### ファイアーウォール（城壁モデル）には限界があります

近年では，リモートワークの一般化やクラウドサービスの普及によって，ファイアーウォールの概念は時代遅れになりつつあります。

しかし，ネットワークセキュリティにおいてパケットフィルタリングやNATなどの機能は必須なので，ここではその設定方法について学びます。

## ターミナル／power shell を２つ起動

* 両方とも ssh サーバにログインする

```
ssh ユーザIDを@106.157.214.199
```

* 片方だけ，ラズパイマシンにログインする



## iptabelsの確認（ラズパイマシン）

```
sudo iptables -L
```

### ルールの削除とユーザチェーンの消去

```
sudo iptables -F
sudo iptables -X

sudo -t nat iptables -F
sudo -t nar iptables -X
```

### 確認

```
sudo iptables -L

sudo iptables -t nat -L

```

## ファイアーウォール用スクリプトの作成


毎回設定コマンドを入力するのは現実的でないので、代わりにシェルスクリプトを作成する

## 方針

router1(192.168.2.1)と enshu1 （192.168.2.2）からはssh でアクセスできるが，他のラズパイマシンからは　ssh アクセスできないようにする。

## 事前チェック


事前にネットワーク・インターフェース名を確認する

```bash
ip addr
```


### シェルスクリプトファイルの作成

```
cd ~
nano fw1.sh
```


```bash
#!/bin/bash

# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X
```

## アクセスの確認

### httpの確認

curl コマンドでwebサーバにアクセスできることを確認

```bash
curl www.kindai.ac.jp

<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>302 Found</title>
</head><body>
<h1>Found</h1>
<p>The document has moved <a href="https://www.kindai.ac.jp/">here</a>.</p>
</body></html>
ubuntu@ubuntu:~$ 
ubuntu@ubuntu:~$ 
ubuntu@ubuntu:~$ 
ubuntu@ubuntu:~$ 
ubuntu@ubuntu:~$ 
ubuntu@ubuntu:~$ curl www.kindai.ac.jp
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>302 Found</title>
</head><body>
<h1>Found</h1>
<p>The document has moved <a href="https://www.kindai.ac.jp/">here</a>.</p>
</body></html>

```

## ポリシーの作成例

### ポート開放の基本方針

* ssh (tcp 22) 宛のINPUTをACCEPT
* ssh (tcp 22) からのOUTPUTをACCEPT

FW1ルータ

```
cd ~
nano fw1.sh
```


```bash
#!/bin/bash
#!/bin/bash

# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X

# ssh サーバへのINPUTを許可する
sudo iptables -A INPUT -i eth0 -p tcp --dport 22 -j ACCEPT

# ssh サーバからのOUTPUTを許可する
sudo iptables -A OUTPUT -o eth0 -p tcp --sport 22 -j ACCEPT

# UDP と ICMPはすべて許可する
sudo iptables -A INPUT -i eth0 -p icmp -j ACCEPT
sudo iptables -A INPUT -i eth0 -p udp -j ACCEPT

# それ以外の入力は拒否
sudo iptables -A INPUT  -i eth0 -j DROP

```

### httpができなくなっていることを確認

```bash
curl www.kindai.ac.jp
```

### httpのポートを開ける

```
cd ~
nano fw1.sh
```


```bash
#!/bin/bash
#!/bin/bash

# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X

# ssh サーバへのINPUTを許可する
sudo iptables -A INPUT -i eth0 -p tcp --dport 22 -j ACCEPT

# ssh サーバからのOUTPUTを許可する
sudo iptables -A OUTPUT -o eth0 -p tcp --sport 22 -j ACCEPT

# http サーバーからの応答を許可する
sudo iptables -A INPUT -i eth0 -p tcp --sport 80 -j ACCEPT

# UDP と ICMPはすべて許可する
sudo iptables -A INPUT -i eth0 -p icmp -j ACCEPT
sudo iptables -A INPUT -i eth0 -p udp -j ACCEPT

# それ以外の入力は拒否
sudo iptables -A INPUT  -i eth0 -j DROP

```

## C言語

### 実行ファイル名付きでコンパイル

* 実行ファイル名を 'hello' とする

```bash
gcc -o hello hello.c
```

* コンパイルした実行ファイルの実行

```bash
./hello
hello hello hello
```

### 変数宣言の確認


* 整数型の変数aを宣言する

```bash
nano integer.c
```

```c
#include <stdio.h>
int main(void)
{
  int a;
  a=100;
  return 0;
}
```

```bash
clang integer.c
```

```bash
./a.out
```

### printf文による出力


integer.c

```c
#include <stdio.h>
int main(void)
{
  int a;
  a=100;
  printf("%d",a);
  return 0;
}
```

```bash
clang integer.c
```

```bash
./a.out
```

### 出力を改行する

integer.c

```c
#include <stdio.h>
int main(void)
{
  int a;
  a=100;
  printf("%d\n",a);
  return 0;
}
```

```bash
clang integer.c
```

```bash
./a.out
```


### 変数宣言と代入を一度にやる

integer.c

```c
#include <stdio.h>
int main(void)
{
  int a=100;
  printf("%d\n",a);
  return 0;
}
```

```bash
clang integer.c
```

```bash
./a.out
```

### アドレス演算子を利用して変数のアドレスを得る

```bash
nano address.c
```

```c
#include <stdio.h>
int main()
{
int a=100;
printf("%p\n",&a);
return 0;
}

```

```bash
clang address.c
```

```bash
./a.out
```

### ポインタと間接演算子

```bash
nano pointer.c
```


```c
#include <stdio.h>
int main()
{
  int a = 100;
  int *p;
  p = &a;  /* ポインタpに変数aのアドレスを代入する*/
  printf("%d\n", *p);
  return 0;
}
```

```bash
clang pointer.c
```

```bash
./a.out
```


### ポインタ変数が指すオブジェクトの変更


 pointer.c
 
 ```c
 #include <stdio.h>
int main(){
    int a = 100;
    int b = 500;
    int *p;
    p = &a;
    printf("%d\n", *p);
    p = &b;
    printf("%d\n", *p);
    return 0;
}

 ```



### コマンドライン引数

```bash
nano kodama.c
```


```c
#include <stdio.h>
int main(int argc, char *argv[])
{
  puts(argv[1]);
  return 0;
}
```

* コンパイル

```bash
clang -o kodama kodama.c
```

* 実行


```bash
./kodama これは日本語のメッセージです
```


### 変数宣言の確認


* 整数型の変数aを宣言する

```bash
nano integer.c
```

```c
#include <stdio.h>
int main(void)
{
  int a;
  a=100;
  return 0;
}
```

```bash
clang integer.c
```

```bash
./a.out
```

### printf文による出力


integer.c

```c
#include <stdio.h>
int main(void)
{
  int a;
  a=100;
  printf("%d",a);
  return 0;
}
```

```bash
clang integer.c
```

```bash
./a.out
```

### 出力を改行する

integer.c

```c
#include <stdio.h>
int main(void)
{
  int a;
  a=100;
  printf("%d\n",a);
  return 0;
}
```

```bash
clang integer.c
```

```bash
./a.out
```


### 変数宣言と代入を一度にやる

integer.c

```c
#include <stdio.h>
int main(void)
{
  int a=100;
  printf("%d\n",a);
  return 0;
}
```

```bash
clang integer.c
```

```bash
./a.out
```

### アドレス演算子を利用して変数のアドレスを得る

```bash
nano address.c
```

```c
#include <stdio.h>
int main()
{
int a=100;
printf("%p\n",&a);
return 0;
}

```

```bash
clang address.c
```

```bash
./a.out
```

### ポインタと間接演算子

```bash
nano pointer.c
```


```c
#include <stdio.h>
int main()
{
  int a = 100;
  int *p;
  p = &a;  /* ポインタpに変数aのアドレスを代入する*/
  printf("%d\n", *p);
  return 0;
}
```

```bash
clang pointer.c
```

```bash
./a.out
```


### ポインタ変数が指すオブジェクトの変更


 pointer.c
 
 ```c
 #include <stdio.h>
int main(){
    int a = 100;
    int b = 500;
    int *p;
    p = &a;
    printf("%d\n", *p);
    p = &b;
    printf("%d\n", *p);
    return 0;
}

 ```



### コマンドライン引数

```bash
nano kodama.c
```


```c
#include <stdio.h>
int main(int argc, char *argv[])
{
  puts(argv[1]);
  return 0;
}
```

* コンパイル

```bash
clang -o kodama kodama.c
```

* 実行


```bash
./kodama hello
```

### C言語の配列


array.c

```c
#include <stdio.h>
int main(){
  int a[3];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a[0]=%d,a[1]=%d,a[2]=%d\n",a[0],a[1],a[2]);
  return 0;
}

```

### ポインタとしての配列

```c
#include <stdio.h>
int main(){
  int a[3];
  int *p;
  p=&a[0];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("*p=%d\n",*p);
  return 0;
}
```

### 配列変数はポインタ変数

```c
#include <stdio.h>
int main(){
  int a[3];
  int *p;
  p=a;
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("*p=%d\n",*p);
  return 0;
}

```

### C言語の文字列は文字の配列

```c
#include <stdio.h>
int main(){
  char *aisatu;
  aisatu="hello";
  puts(aisatu);
  return 0;
}

```

### コマンドライン引数の配列

```c
#include <stdio.h>
int main(int argc, char *argv[]){
  printf("argc: %d\n",argc);
  for(int i=0; i<argc ; ++i){
    printf("argv: %s\n",argv[i]);
  }
}

```

### ポインタのポインタ

```c
#include <stdio.h>
int main(void){
    int a = 0;
    int *p;   /*整数へのポインタ*/
    int **pp; /*整数へのポインタのポインタ*/
    p=&a;
    pp=&p;
    printf("**pp=%d\n", **pp);
    return 0;
}

```

