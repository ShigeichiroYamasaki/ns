# ネットワークセキュリティ演習 11回  TLS

最終更新 2022/11/03 Shigeichiro yamasaki

##  演習の目的と概要

* TLSサーバ証明書の確認
* TLSサーバの構築

## 演習の手順

* 1. webブラウザでTLS証明書を確認する
* 2. s_clientで代表的なTLSサーバの証明書を確認する
* 3. TLSサーバの構築
* 4. TLSサーバの公開鍵証明書の発行
* 5. PKCS12形式の個人証明書のファイルを作成する


## システム構成


## 1. webブラウザでTLS証明書を確認する

### fairefox ブラウザ

* 右上の 三 アイコンをクリック
* 「設定」を選択
* 左側の「プライバシーとセキュリティ」を選択
* 下の方にスクロールして「セキュリティ」の中の「証明書を表示...」をクリック

#### firefoxブラウザの証明書マネージャー

* 認証局証明を確認する
    * webtrust for CA の認証局のリストを確認する
* 個人証明書が空であることを確認する
* あなたの証明書が空であることを確認する

#### 「セキュリティデバイス...」をクリックしてデバイスマネージャーを表示

* セキュリティーモジュールとデバイスを確認
    * 内容を確認する
* 「追加...」ボタンをクリックして「PKCS#11 デバイスドライバーの読み込み」が表示されることを確認する

### 近畿大学のサーバにアクセスする

* www.kindai.ac.jp にアクセス
* URLの左にある 鍵 のアイコンをクリックする
* 「詳細を表示」をクリック
* 「セキュリティ」の「証明書を表示」をクリック
* 証明書の内容を確認する（メモしてください）


## 2. s_clientで代表的なTLSサーバの証明書を確認する

### s_clientの基本操作

TLSクライアントとして，TLSサーバに接続する

```bash
openssl s_client -connect <サーバのFQDN>:443

...
---
read R BLOCK
Q <- と入れると終了する
```

### 総務省サーバに接続して，TLSのバージョンやTLSサーバ証明書などを確認する

```bash
$ openssl s_client -connect www.soumu.go.jp:443
```

応答の次の項目を確認してる

* ルートCAのDN
* subject DN
* 発行者のDN
* TLSプロトコルのバージョン
* 暗号方式


```
CONNECTED(00000003)
depth=2 C = JP, O = "SECOM Trust Systems CO.,LTD.", OU = Security Communication RootCA2
verify return:1
depth=1 C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA
verify return:1
depth=0 C = JP, ST = Tokyo, L = Chiyoda-ku, O = Ministry of Internal Affairs and Communications, jurisdictionC = JP, businessCategory = Government Entity, serialNumber = 2000012020001, OU = Ministry of Internal Affairs and Communications, CN = www.soumu.go.jp
verify return:1
---
Certificate chain
 0 s:C = JP, ST = Tokyo, L = Chiyoda-ku, O = Ministry of Internal Affairs and Communications, jurisdictionC = JP, businessCategory = Government Entity, serialNumber = 2000012020001, OU = Ministry of Internal Affairs and Communications, CN = www.soumu.go.jp
   i:C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA
 1 s:C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA
   i:C = JP, O = "SECOM Trust Systems CO.,LTD.", OU = Security Communication RootCA2
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIHZTCCBk2gAwIBAgIRANrzGDNi2hWHAAAAAFP8KaswDQYJKoZIhvcNAQELBQAw
XzELMAkGA1UEBhMCSlAxJTAjBgNVBAoTHFNFQ09NIFRydXN0IFN5c3RlbXMgQ08u
LExURC4xKTAnBgNVBAMTIFNFQ09NIFBhc3Nwb3J0IGZvciBXZWIgRVYgMi4wIENB
MB4XDTIxMDUxOTA2MTEzNVoXDTIyMDYxMjE0NTk1OVowggEJMQswCQYDVQQGEwJK
UDEOMAwGA1UECBMFVG9reW8xEzARBgNVBAcTCkNoaXlvZGEta3UxODA2BgNVBAoT
L01pbmlzdHJ5IG9mIEludGVybmFsIEFmZmFpcnMgYW5kIENvbW11bmljYXRpb25z
MRMwEQYLKwYBBAGCNzwCAQMTAkpQMRowGAYDVQQPExFHb3Zlcm5tZW50IEVudGl0
eTEWMBQGA1UEBRMNMjAwMDAxMjAyMDAwMTE4MDYGA1UECxMvTWluaXN0cnkgb2Yg
SW50ZXJuYWwgQWZmYWlycyBhbmQgQ29tbXVuaWNhdGlvbnMxGDAWBgNVBAMTD3d3
dy5zb3VtdS5nby5qcDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAK19
m1uCDHunOaXQv2519i+y7LQbPXMm+5Y1yx8bfpTxtfTtxBzk8LxO2SbN7jPJPOYT
tlqCHUCvn7o2nrWDFkqNveO0YZuqDhqtGL6ZTSzxvOuUzLcyLpuR5q6DCdQ/NyjI
aeYx2Z8PobuF9wmt3dvHOmPJ6t859BGejel2PbLhrV7OmKYFCzeNTrsK7RVBTHud
1xCHLUx1um6Xaa1etgYOnMdCrzRYnp3gaziOsSYh9ExVtTmF6TgVYyHwGganr2UP
d6EBnV0JmPZDwCzr/Jg7wQwkatgCubqSp+AdqerAWUacBl09Q0cyzRyAptQISGP2
YRdn9MgCQacs5yKJu5sCAwEAAaOCA24wggNqMIIBfwYKKwYBBAHWeQIEAgSCAW8E
ggFrAWkAdgApeb7wnjk5IfBWc59jpXflvld9nGAK+PlNXSZcJV3HhAAAAXmDW7P1
AAAEAwBHMEUCIQD323Wrdtvco/Gve6AZ33JU4CsCds4xBfis8NFoFCx+4wIgZ94P
F+pgBfQ7zmlOrGlOsUurAxqlDXnhjYyleR7MASsAdgBGpVXrdfqRIDC1oolp9PN9
ESxBdL79SbiFq/L8cP5tRwAAAXmDW7mKAAAEAwBHMEUCIQCgLFVU0DMTgSzFaLZa
EJAB/vRwzv47qeVlBqQ2iOs0yAIga5J/Z+ZfRaET9ngFIh2iZufAoKc2lwQD6cx7
C3FPFEcAdwAiRUUHWVUkVpY/oS/x922G4CMmY63AS39dxoNcbuIPAgAAAXmDW7zW
AAAEAwBIMEYCIQCPwDlfI72P1EZNRvnAVn2V8p8Eu/RQ5rPulab1kLYoMwIhAJWT
8IAi30LX1SLlwMlAeZ8jTm1hXLp/eqkiDkw5vMBjMA4GA1UdDwEB/wQEAwIFoDAT
BgNVHSUEDDAKBggrBgEFBQcDATA6BggrBgEFBQcBAQQuMCwwKgYIKwYBBQUHMAGG
Hmh0dHA6Ly9ldjIub2NzcC5zZWNvbXRydXN0Lm5ldDBgBgNVHSAEWTBXMEwGCiqD
CIybG2SFUQEwPjA8BggrBgEFBQcCARYwaHR0cHM6Ly9yZXBvMS5zZWNvbXRydXN0
Lm5ldC9zcGNwcC9wZncvcGZ3ZXYyY2EvMAcGBWeBDAEBMBoGA1UdEQQTMBGCD3d3
dy5zb3VtdS5nby5qcDCBxQYDVR0fBIG9MIG6MECgPqA8hjpodHRwOi8vcmVwbzEu
c2Vjb210cnVzdC5uZXQvc3BjcHAvcGZ3L3Bmd2V2MmNhL2Z1bGxjcmwuY3JsMHag
dKBypHAwbjELMAkGA1UEBhMCSlAxJTAjBgNVBAoTHFNFQ09NIFRydXN0IFN5c3Rl
bXMgQ08uLExURC4xKTAnBgNVBAMTIFNFQ09NIFBhc3Nwb3J0IGZvciBXZWIgRVYg
Mi4wIENBMQ0wCwYDVQQDEwRDUkw3MB8GA1UdIwQYMBaAFBZL+wyXOIoYWlShRs+J
JEfMxHazMB0GA1UdDgQWBBQtGZtK0mTUahooI/nAeluA/UZ6bjANBgkqhkiG9w0B
AQsFAAOCAQEAmwCUJggk4ISMtkZ9G1N0PGX2ui9XHlQyFs4RaEN6LTHLOMpgI3gE
OFBW5ugWDVaHZsTQRZpHYU/+dPfKw1kSSU6a+/jB7iurQUTfvs3Z+FdxenTzB9c6
lBWuiB2VXzPmDaSOH+1Kk/0jLCtVcsSMw3VSD/m9j1jsPSQEXhernml+gdIQqjky
p+OVvFh66dkwMkNTRPvAQA7xOtZB+52++F2oPdruvz3NRuLsfylcA/1XlhyRwcWf
EGnhfzDwulUTQ1t4ELXtpMA3wBgyaHlgPM3p6oT1G9Cx4nBSOuv9q41iC8ENe9Si
0hHbL3pwXyFXs7l+xzLiS8XOibr4jmyb/A==
-----END CERTIFICATE-----
subject=C = JP, ST = Tokyo, L = Chiyoda-ku, O = Ministry of Internal Affairs and Communications, jurisdictionC = JP, businessCategory = Government Entity, serialNumber = 2000012020001, OU = Ministry of Internal Affairs and Communications, CN = www.soumu.go.jp

issuer=C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA

---
No client certificate CA names sent
Peer signing digest: SHA256
Peer signature type: RSA-PSS
Server Temp Key: X25519, 253 bits
---
SSL handshake has read 3617 bytes and written 387 bytes
Verification: OK
---
New, TLSv1.3, Cipher is TLS_AES_256_GCM_SHA384
Server public key is 2048 bit
Secure Renegotiation IS NOT supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
Early data was not sent
Verify return code: 0 (ok)
---
---
Post-Handshake New Session Ticket arrived:
SSL-Session:
    Protocol  : TLSv1.3
    Cipher    : TLS_AES_256_GCM_SHA384
    Session-ID: EC7BCA5E275C8F30D00F01DF8541F102C3396D43D4A87203BABBE38DFD8D43AB
    Session-ID-ctx: 
    Resumption PSK: E5B3BB45EF7DF158ACB750AFDB3C2DF3D4587C98C11BE5EBB1A8614CE7CA48BE174D009108AB5FD422886D65193B1B35
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 300 (seconds)
    TLS session ticket:
    0000 - c8 15 e1 a8 12 82 4f b9-7d 02 5c 8c b9 63 bc 0d   ......O.}.\..c..
    0010 - 1a b5 7c 8d 8b 50 76 20-d7 8e 74 67 0e 09 bc 02   ..|..Pv ..tg....
    0020 - 18 45 4d 35 17 01 b3 e5-5a d0 c4 f0 40 01 4b 84   .EM5....Z...@.K.
    0030 - 17 56 bb 7f 23 6c 8e 6c-de a0 3b 81 35 28 31 45   .V..#l.l..;.5(1E
    0040 - bf b9 e9 46 69 40 8a 92-3f c9 98 53 49 c4 a1 bc   ...Fi@..?..SI...
    0050 - d7 8d ed ef 1f 0f 87 e4-ee 74 09 4f 91 b1 43 3d   .........t.O..C=
    0060 - 7e 11 33 74 38 ee de 15-90 bf 9c e5 c9 31 7d 54   ~.3t8........1}T
    0070 - 55 08 71 f7 8c 55 7e 8e-cf b5 25 05 47 2e 9f 30   U.q..U~...%.G..0
    0080 - 8c a1 b7 f8 af 88 b7 0e-37 c3 e4 85 11 f7 26 40   ........7.....&@
    0090 - d9 bc 31 5d 6d 7d 80 dd-6c a6 7f 01 83 ae bb 3d   ..1]m}..l......=
    00a0 - fb 92 db 3c b8 c6 d8 8a-59 5c 1a f9 49 65 82 3e   ...<....Y\..Ie.>
    00b0 - ba 34 84 12 55 0b b7 32-f9 20 ac 1b 23 14 ed 12   .4..U..2. ..#...
    00c0 - ba 32 7d 54 37 62 b0 73-9e 13 8a b2 ab 5e c5 07   .2}T7b.s.....^..
    00d0 - 9f 41 0c e6 c7 93 00 eb-67 95 ef 5e 41 49 4c 76   .A......g..^AILv
    00e0 - cc aa 73 a0 d4 bb 1a e1-1b 1e ae 5d c9 09 c4 99   ..s........]....

    Start Time: 1638087404
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
    Max Early Data: 0
---
read R BLOCK
---
Post-Handshake New Session Ticket arrived:
SSL-Session:
    Protocol  : TLSv1.3
    Cipher    : TLS_AES_256_GCM_SHA384
    Session-ID: 3F88AAD8A540D9AF19077274747E178C87F6E25AB6434C82AF89C80824AFDB5D
    Session-ID-ctx: 
    Resumption PSK: 181AC16812B4A265D4A227999B027785FB8F62E78FA6D311ABCD79BE0FD834BFB3EBEA3622C7B152B48EE8096D7ACB6A
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 300 (seconds)
    TLS session ticket:
    0000 - c8 15 e1 a8 12 82 4f b9-7d 02 5c 8c b9 63 bc 0d   ......O.}.\..c..
    0010 - 5b b3 5f e5 8c c1 89 58-89 5d a2 6f 8e c7 f4 f2   [._....X.].o....
    0020 - 3e 5c 8a 17 69 27 4e be-ff 38 23 d7 25 71 ee f5   >\..i'N..8#.%q..
    0030 - 30 57 22 e7 62 03 59 2c-4d 7b 14 75 33 d1 3e a1   0W".b.Y,M{.u3.>.
    0040 - 87 94 37 dd 60 19 65 54-5a a4 dd 54 1d 06 18 77   ..7.`.eTZ..T...w
    0050 - 1e c9 d1 6b 88 db eb 5d-30 51 02 2e c6 2f c2 c3   ...k...]0Q.../..
    0060 - 4b 89 16 99 05 af 01 ec-df fa 53 22 6e ad 8c 3d   K.........S"n..=
    0070 - e0 14 59 f0 50 ce 2e 46-70 6d c1 b6 79 4f fd 2e   ..Y.P..Fpm..yO..
    0080 - 34 fa 41 d8 b2 77 d9 6c-97 5f 67 bd fd 1a 53 0e   4.A..w.l._g...S.
    0090 - 88 d8 43 5b 9d d4 2e fc-05 f4 52 c9 ea b5 a4 48   ..C[......R....H
    00a0 - d1 ff 4a 85 73 4b c9 4e-66 b7 02 dc b7 4c 44 fa   ..J.sK.Nf....LD.
    00b0 - 0e b4 ed 6a 96 ae db ba-34 b2 01 f4 60 58 32 af   ...j....4...`X2.
    00c0 - 1d 69 bc 86 af be db f1-a8 0d 04 de de 16 f5 a6   .i..............
    00d0 - 3d 96 45 5e d4 a4 d8 64-a9 16 30 b7 37 3d 1c 86   =.E^...d..0.7=..
    00e0 - 81 ca 11 79 fc 9b 15 37-01 77 f1 07 42 d0 4c 11   ...y...7.w..B.L.

    Start Time: 1638087404
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
    Max Early Data: 0
---
read R BLOCK
```

* ルートCAのDN：
     depth=2 C = JP, O = "SECOM Trust Systems CO.,LTD.", OU = Security Communication RootCA2
    depth=1 C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA
    depth=0 C = JP, ST = Tokyo, L = Chiyoda-ku, O = Ministry of Internal Affairs and Communications, jurisdictionC = JP, businessCategory = Government Entity, serialNumber = 2000012020001, OU = Ministry of Internal Affairs and Communications, CN = www.soumu.go.jp


* subject DN：
     subject=C = JP, ST = Tokyo, L = Chiyoda-ku, O = Ministry of Internal Affairs and Communications, jurisdictionC = JP, businessCategory = Government Entity, serialNumber = 2000012020001, OU = Ministry of Internal Affairs and Communications, CN = www.soumu.go.jp

* 発行者のDN：
     issuer=C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA

* TLSプロトコルのバージョン：Protocol  : TLSv1.3
* 暗号方式： TLS_AES_256_GCM_SHA384

### s_clientでTLSサーバの証明書を確認する

確認事項

* ルートCAのDN
* subject DN
* 発行者のDN
* TLSプロトコルのバージョン
* 暗号方式


#### 飯塚市

```bash
$ openssl s_client -connect www.city.iizuka.lg.jp:443
```

#### 東京都

```bash
$ openssl s_client -connect www.metro.tokyo.lg.jp:443
```

#### 近畿大学

```bash
$ openssl s_client -connect www.kindai.ac.jp:443
```

### 三井住友銀行

```bash
$ openssl s_client -connect www.smbc.co.jp:443
```

#### Google

```bash
$ openssl s_client -connect www.google.com:443
```

## 3. TLSサーバの構築

### ポート番号の確認

443 ポートがアクティブでないことを確認する

```bash
ss -lnt

State            Recv-Q           Send-Q                     Local Address:Port                     Peer Address:Port          Process          
LISTEN           0                4096                       127.0.0.53%lo:53                            0.0.0.0:*                              
LISTEN           0                128                              0.0.0.0:22                            0.0.0.0:*                              
LISTEN           0                100                              0.0.0.0:25                            0.0.0.0:*                              
LISTEN           0                511                                    *:80                                  *:*                              
LISTEN           0                128                                 [::]:22                               [::]:*                              
LISTEN           0                100                                 [::]:25                               [::]:*                              

```

### apache2 の再インストール

```bash
$ sudo apt --reinstall install apache2
```

### apache2 へのTLSの設定

```bash
$ sudo a2enmod ssl

sudo のパスワード: 

Considering dependency setenvif for ssl:
Module setenvif already enabled
Considering dependency mime for ssl:
Module mime already enabled
Considering dependency socache_shmcb for ssl:
Enabling module socache_shmcb.
Enabling module ssl.
See /usr/share/doc/apache2/README.Debian.gz on how to configure SSL and create self-signed certificates.
To activate the new configuration, you need to run:
  systemctl restart apache2
```

```bash
$ sudo a2ensite default-ssl
```

### apache2 の再起動

```bash
$ sudo systemctl reload apache2
```

### ポート番号の確認

Local Address:Port   のところを見て，443ポートがアクティブになっていることを確認する

```
$ ss -lnt

State     Recv-Q     Send-Q          Local Address:Port          Peer Address:Port     
LISTEN    0          128             127.0.0.53%lo:53                 0.0.0.0:*        
LISTEN    0          128                   0.0.0.0:22                 0.0.0.0:*        
LISTEN    0          5                   127.0.0.1:631                0.0.0.0:*        
LISTEN    0          80                  127.0.0.1:3306               0.0.0.0:*        
LISTEN    0          128                      [::]:22                    [::]:*        
LISTEN    0          5                       [::1]:631                   [::]:*        
LISTEN    0          128                         *:443                      *:*        
LISTEN    0          128                         *:80                       *:*        

```

## 4. TLSサーバの公開鍵証明書の発行

### DNの設計

* TLS サーバのCNは、FQDN
	ドメイン名が無い場合は、IPアドレス
	他は、CAと同じにする
* 管理者の電子メールアドレス

* 国＝日本の
	* C＝JP
* 州県＝福岡県の
	*  ST=Fukuoka
* 市＝飯塚市の
	* L=Iizuka
* 組織＝近畿大学の
	* O=Kindai University
* 部署＝班の名前
	* OU=Joho
* 標準名＝TLSサーバのドメイン名（IPアドレス）
	* CN=192.168.1.xx

### OpenSSLの設定ファイルの修正

opensslのデフォルトの設定を修正してサーバー証明書／クライアント証明書に対応させる

```bash
$ sudo nano /etc/ssl/openssl.cnf 
```

* [ req_distinguished_name ]のセクションを以下のように修正する

```
...
[ req_distinguished_name ]
countryName                     = Country Name (2 letter code)
countryName_default             = JP
countryName_min                 = 2
countryName_max                 = 2

stateOrProvinceName             = State or Province Name (full name)
stateOrProvinceName_default     = Fukuoka

localityName                    = Locality Name (eg, city)
localityName_default            = Iizuka

0.organizationName              = Organization Name (eg, company)
0.organizationName_default      = Kindai University 
```

* [ usr_cert ] のセクションを以下のように修正

`#` で始まる行はコメントなので無視して構いません

```
basicConstraints=CA:FALSE

keyUsage = digitalSignature, keyEncipherment

nsComment                       = "OpenSSL Generated Certificate"

subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid,issuer

extendedKeyUsage = serverAuth, clientAuth

```


### TLSサーバのRSA鍵の生成

サーバ名を自分の名前にする

山崎の場合　→ yamasaki_server

```bash
$ cd ~/ippanjin

$ openssl genrsa 2048 > yamasaki_server.key
```
### CSRの生成

```bash
openssl req -new -key yamasaki_server.key -out yamasaki_server.csr
```

DNを設計どおりに入力する
入力内容がデフォルトを一致する場合は，enterキーで進めることができます．

```
Country Name (2 letter code) [JP]:
State or Province Name (full name) [Fukuoka]:
Locality Name (eg, city) [Iizuka]:
Organization Name (eg, company) [Kindai University]:
Organizational Unit Name (eg, section) []:Joho
Common Name (e.g. server FQDN or YOUR name) []:192.168.1.242
Email Address []:yamasaki@fuk.kindai.ac.jp

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
```






###  証明書リクエストファイル (CSR) をCAに渡す
  
  demoCAのディレクトリにコピーするだけ
  
```
$ sudo cp yamasaki_server.csr /usr/lib/ssl/misc/
```
  
### CA として公開鍵証明書を作成する

CAのディレクトリに移動

```bash
$ cd /usr/lib/ssl/misc/
```

リクエストファイルを確認する

```bash
ls

yamasaki_server.csr
```

### CAとしてCSRに電子署名を行い、公開鍵証明書 （CRT)を作成する

```bash
$ sudo openssl ca -in yamasaki_server.csr -out yamasaki_server.crt
```

yesを２回入力すると成功

同じDNの証明書は再度作成できないので注意

### 公開鍵証明書の確認

```bash
$ openssl x509 -text -in yamasaki_server.crt -noout
```

以下を確認してメモする

* X509v3 Basic Constraints: 
* X509v3 Key Usage: 
* X509v3 Extended Key Usage: 

```
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            04:67:3a:7e:46:f5:45:21:09:95:13:5a:73:5b:73:8a:8f:05:48:19
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C = JP, ST = Fukuoka, O = Kindai University, OU = Joho, CN = Kindai CA
        Validity
            Not Before: Nov 16 12:55:40 2022 GMT
            Not After : Nov 16 12:55:40 2023 GMT
        Subject: C = JP, ST = Fukuoka, O = Kindai University, OU = Joho, CN = 192.168.0.242, emailAddress = yamasaki@fuk.kindai.ac.jp
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (2048 bit)
                Modulus:
                    00:e2:8d:5d:c8:f0:ce:57:e1:97:70:a9:29:2c:e0:
                    b0:b2:74:bb:69:61:9a:f7:41:9c:7d:c7:81:76:f7:
                    fc:be:98:8c:b4:dc:1c:6d:87:17:18:12:dd:18:ab:
                    2f:26:cb:2a:05:1e:59:8e:8a:f8:3b:01:47:aa:e7:
                    7e:ff:76:f7:ac:c7:e7:5c:de:54:db:fd:95:ad:67:
                    f8:f2:f6:20:c4:07:18:e3:c7:2a:e3:ef:20:8f:ee:
                    30:28:63:e4:51:29:80:d6:7c:40:1a:ef:c6:66:e9:
                    43:17:8a:48:ef:c6:20:64:8c:ba:05:a8:f2:b9:07:
                    e9:21:68:5c:bb:7d:5e:cd:f5:0c:e3:8b:76:3d:46:
                    0c:41:52:cb:bb:23:d6:ca:e2:6c:a6:47:e4:c3:d5:
                    ec:83:61:1e:4b:c3:83:84:10:b7:39:1d:ea:6c:f3:
                    3d:ce:ac:44:fc:b1:43:10:15:46:8e:7f:03:50:33:
                    d3:e2:9c:4b:bd:75:c8:ff:21:b7:53:c3:d8:41:da:
                    51:f4:7a:c2:16:44:03:6c:e0:38:1c:a1:03:41:75:
                    35:4d:31:84:92:3a:b0:77:ae:d6:5a:1e:6d:66:05:
                    dd:ca:8d:5e:72:c7:d7:f5:b6:db:c6:39:80:7f:9d:
                    92:53:7f:b4:99:72:bb:6b:08:6e:ac:af:03:df:df:
                    76:ab
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            X509v3 Key Usage: 
                Digital Signature, Key Encipherment
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                3B:1F:CE:1D:54:64:35:A0:7C:F3:B1:F6:F6:7D:F9:69:07:44:39:F8
            X509v3 Authority Key Identifier: 
                keyid:6A:2E:CC:C2:32:A5:4A:65:DA:A8:8C:D2:35:9E:49:53:EA:76:18:24

            X509v3 Extended Key Usage: 
                TLS Web Server Authentication, TLS Web Client Authentication
    Signature Algorithm: sha256WithRSAEncryption
         79:da:72:75:93:85:5d:d5:9d:90:bb:be:a3:e8:92:21:2d:22:
         aa:03:bd:e3:58:a4:24:57:2b:dc:da:ff:92:32:60:7a:eb:b2:
         f5:39:21:58:72:ca:88:1e:a8:0a:b7:d5:9a:53:43:d1:a1:33:
         88:27:a5:ff:59:ab:31:35:1a:0c:39:d7:4c:5e:8b:5a:87:c3:
         bb:73:06:47:bc:a6:59:ff:d0:67:0a:64:5b:08:0f:56:19:c9:
         a9:f0:b6:be:7f:3a:9f:7a:21:c8:5e:b0:3c:b8:49:27:ba:23:
         28:31:5d:fb:fc:93:87:a5:ca:ee:16:74:04:48:ca:99:e7:58:
         2c:e8:d1:7b:9c:84:e5:de:ab:b2:f8:2a:e6:ef:f0:28:89:c6:
         2e:56:5d:50:fa:b5:31:a9:b4:2a:a9:f5:60:b0:47:b8:1a:40:
         57:b1:9e:cf:04:4d:00:14:16:3c:7d:5d:28:80:91:6b:4a:41:
         b8:b8:ba:21:15:66:18:65:f3:5c:b5:38:5a:78:15:4c:43:35:
         2a:d8:6b:76:41:a1:5a:88:78:5f:ea:2a:e7:0d:fe:ba:6d:83:
         72:fd:95:cf:af:77:11:b1:0e:f8:d4:ee:d2:da:97:b2:6c:4a:
         fe:35:fc:e9:6d:c4:d8:a7:20:02:60:7a:ea:29:dc:75:6c:a4:
         57:c1:3a:bf
```

### CAから申請者に完成した公開鍵証明書を渡す

証明書をCAのディレクトリから個人のディレクトリにコピーするだけ

```bash
$ cp yamasaki_server.crt ~/ippanjin/
```

CAの証明書も自分のディレクトリにコピーしておく

```bash
$ sudo cp /usr/lib/ssl/misc/demoCA/cacert.pem ~/ippanjin/
```

### 自分本人のディレクトリに移動

```bash
$ cd ~/ippanjin
```

```bash
$ ls

cacert.pem  yamasaki_server.crt  yamasaki_server.key server.csr  ...
```

CAの公開鍵証明書、TLSサーバの公開鍵証明書、TLSサーバの秘密鍵、などがあることを確認
  
#### TLSサーバ証明書の確認

 CAの公開鍵証明書をつかって自分の公開鍵証明書が正統なものであることを確認する

```bash
$ openssl verify -CAfile cacert.pem yamasaki_server.crt

server.crt: OK
```

### TLS公開鍵証明書とCA署名書をapacheに組み込む

#### apacheのssl設定ファイルの修正

```bash
$ cd /etc/apache2/sites-enabled/
```

```bash
$ ls

000-default.conf  default-ssl.conf
```

apacheのssl設定ファイルの編集

```bash
$ sudo nano /etc/apache2/sites-enabled/default-ssl.conf
```

設定ファイルの修正箇所

* サーバ証明書のファイル名を yamasaki_server.crt にする
* サーバ秘密鍵のファイル名を yamasaki_server.key にする


★注意： SSLCertificateFile、SSLCertificateKeyFile、が他に無いか確認する

```
    ...
    
                SSLCertificateFile    /etc/ssl/certs/yamasaki_server.crt
                SSLCertificateKeyFile /etc/ssl/private/yamasaki_server.key
                
                #SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
                #   Server Certificate Chain:
                #   Point SSLCertificateChainFile at a file containing the
                #   concatenation of PEM encoded CA certificates which form the
                #   certificate chain for the server certificate. Alternatively
                #   the referenced file can be the same as SSLCertificateFile
                #   when the CA certificates are directly appended to the server
                #   certificate for convinience.
                
                # SSLCertificateChainFile /etc/apache2/cacert.pem   
                
                #   Certificate Authority (CA):
                #   Set the CA certificate verification path where to find CA
                #   certificates for client authentication or alternatively one
   
```

### 自分の証明書ディレクトリに復帰

```bash
$ cd ~/ippanjin
```

### サーバ公開鍵証明書を組み込む


server.crt を /etc/ssl/certs/ ディレクトリにコピーする


```bash
$ sudo cp yamasaki_server.crt /etc/ssl/certs/
```

### サーバ秘密鍵を組み込む


server.key を/etc/ssl/private/ ディレクトリにコピーする


```bash
$ sudo cp yamasaki_server.key /etc/ssl/private/
```
### サーバ証明書検証チェーンのCAを組み込む


/etc/apache2/ssl.crt/ ディレクトリを作成する


```bash
$ sudo mkdir /etc/apache2/ssl.crt

$ sudo cp cacert.pem /etc/apache2/ssl.crt/
```


### TLSサーバを再起動する

```bash
$ sudo service apache2 restart
```


### openssl s_client で接続確認する


```bash
$ openssl s_client 192.168.1.<自分のマシン >:443
```

情報を確認してください


### ブラウザでサーバにアクセスする

``
https://192.168.1.X/signup.html
``
#### ブラウザのエラー表示

![ブラウザのエラー表示](./images/nd1101.png)

### CA証明書をブラウザに組み込む

1. firefoxの「設定」を開く
2. 「プライバシーとセキュリティ」
3. 設定画面の一番下の右側の 「証明書を表示...」 
4. 「認証局証明書」のタブを選ぶ
5. 「インポート」ボタンをクリック
6. homeディレクトリの下の ippanjin ディレクトリの下にある cacert.pem ファイルを組み込む

### あらためてブラウザでアクセスする

``
https://192.168.0.17/signup.html
``

おそらくまだエラーになる（サーバーのCNがFQDNでないため）

## 5. PKCS#12形式の個人証明書のファイルを作成する

先週作成した個人証明書を利用する

```bash
openssl pkcs12 -export -in yamasaki.crt -inkey yamasaki.key -out yamasaki.pfx
```

### PKCS#12 形式の個人証明書と秘密鍵をブラウザに組み込む

1. firefoxの「設定」を開く
2. 「プライバシーとセキュリティ」
3. 設定画面の一番下の右側の 「証明書を表示...」 
4. 「あなたの証明書」のタブを選ぶ
5. 「インポート」ボタンをクリック
6. homeディレクトリの下の ippanjin ディレクトリの下にある yamasaki.pfx ファイルを組み込む



以下の前提でPKCS12形式のファイルを安全に配布する方法を考えてください．

* 100人の社員に配布する
* 2000人の学生に配布する
* 30000人の町民に配布する
* 400000人の市民に配布する


