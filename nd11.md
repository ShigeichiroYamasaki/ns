# ネットワークセキュリティ演習
## 11回  SSL/TLS

## login

山崎家： 

```bash
ssh <ユーザID>@106.157.214.199
```

## raspbeery pi にログイン

自分のマシンにログイン

## openssl s_client の基本

```bash
openssl s_client -connect <サーバのFQDN>:443

...
---
read R BLOCK
Q <- と入れると終了する
```

### 総務省（例）

```bash
openssl s_client -connect www.soumu.go.jp:443
```

応答の次の項目を確認してる

* ルートCAのDN
* subject DN
* 発行者のDN
* TLSプロトコルのバージョン
* 暗号方式


```
CONNECTED(00000003)
depth=2 C = JP, O = "SECOM Trust Systems CO.,LTD.", OU = Security Communication RootCA2
verify return:1
depth=1 C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA
verify return:1
depth=0 C = JP, ST = Tokyo, L = Chiyoda-ku, O = Ministry of Internal Affairs and Communications, jurisdictionC = JP, businessCategory = Government Entity, serialNumber = 2000012020001, OU = Ministry of Internal Affairs and Communications, CN = www.soumu.go.jp
verify return:1
---
Certificate chain
 0 s:C = JP, ST = Tokyo, L = Chiyoda-ku, O = Ministry of Internal Affairs and Communications, jurisdictionC = JP, businessCategory = Government Entity, serialNumber = 2000012020001, OU = Ministry of Internal Affairs and Communications, CN = www.soumu.go.jp
   i:C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA
 1 s:C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA
   i:C = JP, O = "SECOM Trust Systems CO.,LTD.", OU = Security Communication RootCA2
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIHZTCCBk2gAwIBAgIRANrzGDNi2hWHAAAAAFP8KaswDQYJKoZIhvcNAQELBQAw
XzELMAkGA1UEBhMCSlAxJTAjBgNVBAoTHFNFQ09NIFRydXN0IFN5c3RlbXMgQ08u
LExURC4xKTAnBgNVBAMTIFNFQ09NIFBhc3Nwb3J0IGZvciBXZWIgRVYgMi4wIENB
MB4XDTIxMDUxOTA2MTEzNVoXDTIyMDYxMjE0NTk1OVowggEJMQswCQYDVQQGEwJK
UDEOMAwGA1UECBMFVG9reW8xEzARBgNVBAcTCkNoaXlvZGEta3UxODA2BgNVBAoT
L01pbmlzdHJ5IG9mIEludGVybmFsIEFmZmFpcnMgYW5kIENvbW11bmljYXRpb25z
MRMwEQYLKwYBBAGCNzwCAQMTAkpQMRowGAYDVQQPExFHb3Zlcm5tZW50IEVudGl0
eTEWMBQGA1UEBRMNMjAwMDAxMjAyMDAwMTE4MDYGA1UECxMvTWluaXN0cnkgb2Yg
SW50ZXJuYWwgQWZmYWlycyBhbmQgQ29tbXVuaWNhdGlvbnMxGDAWBgNVBAMTD3d3
dy5zb3VtdS5nby5qcDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAK19
m1uCDHunOaXQv2519i+y7LQbPXMm+5Y1yx8bfpTxtfTtxBzk8LxO2SbN7jPJPOYT
tlqCHUCvn7o2nrWDFkqNveO0YZuqDhqtGL6ZTSzxvOuUzLcyLpuR5q6DCdQ/NyjI
aeYx2Z8PobuF9wmt3dvHOmPJ6t859BGejel2PbLhrV7OmKYFCzeNTrsK7RVBTHud
1xCHLUx1um6Xaa1etgYOnMdCrzRYnp3gaziOsSYh9ExVtTmF6TgVYyHwGganr2UP
d6EBnV0JmPZDwCzr/Jg7wQwkatgCubqSp+AdqerAWUacBl09Q0cyzRyAptQISGP2
YRdn9MgCQacs5yKJu5sCAwEAAaOCA24wggNqMIIBfwYKKwYBBAHWeQIEAgSCAW8E
ggFrAWkAdgApeb7wnjk5IfBWc59jpXflvld9nGAK+PlNXSZcJV3HhAAAAXmDW7P1
AAAEAwBHMEUCIQD323Wrdtvco/Gve6AZ33JU4CsCds4xBfis8NFoFCx+4wIgZ94P
F+pgBfQ7zmlOrGlOsUurAxqlDXnhjYyleR7MASsAdgBGpVXrdfqRIDC1oolp9PN9
ESxBdL79SbiFq/L8cP5tRwAAAXmDW7mKAAAEAwBHMEUCIQCgLFVU0DMTgSzFaLZa
EJAB/vRwzv47qeVlBqQ2iOs0yAIga5J/Z+ZfRaET9ngFIh2iZufAoKc2lwQD6cx7
C3FPFEcAdwAiRUUHWVUkVpY/oS/x922G4CMmY63AS39dxoNcbuIPAgAAAXmDW7zW
AAAEAwBIMEYCIQCPwDlfI72P1EZNRvnAVn2V8p8Eu/RQ5rPulab1kLYoMwIhAJWT
8IAi30LX1SLlwMlAeZ8jTm1hXLp/eqkiDkw5vMBjMA4GA1UdDwEB/wQEAwIFoDAT
BgNVHSUEDDAKBggrBgEFBQcDATA6BggrBgEFBQcBAQQuMCwwKgYIKwYBBQUHMAGG
Hmh0dHA6Ly9ldjIub2NzcC5zZWNvbXRydXN0Lm5ldDBgBgNVHSAEWTBXMEwGCiqD
CIybG2SFUQEwPjA8BggrBgEFBQcCARYwaHR0cHM6Ly9yZXBvMS5zZWNvbXRydXN0
Lm5ldC9zcGNwcC9wZncvcGZ3ZXYyY2EvMAcGBWeBDAEBMBoGA1UdEQQTMBGCD3d3
dy5zb3VtdS5nby5qcDCBxQYDVR0fBIG9MIG6MECgPqA8hjpodHRwOi8vcmVwbzEu
c2Vjb210cnVzdC5uZXQvc3BjcHAvcGZ3L3Bmd2V2MmNhL2Z1bGxjcmwuY3JsMHag
dKBypHAwbjELMAkGA1UEBhMCSlAxJTAjBgNVBAoTHFNFQ09NIFRydXN0IFN5c3Rl
bXMgQ08uLExURC4xKTAnBgNVBAMTIFNFQ09NIFBhc3Nwb3J0IGZvciBXZWIgRVYg
Mi4wIENBMQ0wCwYDVQQDEwRDUkw3MB8GA1UdIwQYMBaAFBZL+wyXOIoYWlShRs+J
JEfMxHazMB0GA1UdDgQWBBQtGZtK0mTUahooI/nAeluA/UZ6bjANBgkqhkiG9w0B
AQsFAAOCAQEAmwCUJggk4ISMtkZ9G1N0PGX2ui9XHlQyFs4RaEN6LTHLOMpgI3gE
OFBW5ugWDVaHZsTQRZpHYU/+dPfKw1kSSU6a+/jB7iurQUTfvs3Z+FdxenTzB9c6
lBWuiB2VXzPmDaSOH+1Kk/0jLCtVcsSMw3VSD/m9j1jsPSQEXhernml+gdIQqjky
p+OVvFh66dkwMkNTRPvAQA7xOtZB+52++F2oPdruvz3NRuLsfylcA/1XlhyRwcWf
EGnhfzDwulUTQ1t4ELXtpMA3wBgyaHlgPM3p6oT1G9Cx4nBSOuv9q41iC8ENe9Si
0hHbL3pwXyFXs7l+xzLiS8XOibr4jmyb/A==
-----END CERTIFICATE-----
subject=C = JP, ST = Tokyo, L = Chiyoda-ku, O = Ministry of Internal Affairs and Communications, jurisdictionC = JP, businessCategory = Government Entity, serialNumber = 2000012020001, OU = Ministry of Internal Affairs and Communications, CN = www.soumu.go.jp

issuer=C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA

---
No client certificate CA names sent
Peer signing digest: SHA256
Peer signature type: RSA-PSS
Server Temp Key: X25519, 253 bits
---
SSL handshake has read 3617 bytes and written 387 bytes
Verification: OK
---
New, TLSv1.3, Cipher is TLS_AES_256_GCM_SHA384
Server public key is 2048 bit
Secure Renegotiation IS NOT supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
Early data was not sent
Verify return code: 0 (ok)
---
---
Post-Handshake New Session Ticket arrived:
SSL-Session:
    Protocol  : TLSv1.3
    Cipher    : TLS_AES_256_GCM_SHA384
    Session-ID: EC7BCA5E275C8F30D00F01DF8541F102C3396D43D4A87203BABBE38DFD8D43AB
    Session-ID-ctx: 
    Resumption PSK: E5B3BB45EF7DF158ACB750AFDB3C2DF3D4587C98C11BE5EBB1A8614CE7CA48BE174D009108AB5FD422886D65193B1B35
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 300 (seconds)
    TLS session ticket:
    0000 - c8 15 e1 a8 12 82 4f b9-7d 02 5c 8c b9 63 bc 0d   ......O.}.\..c..
    0010 - 1a b5 7c 8d 8b 50 76 20-d7 8e 74 67 0e 09 bc 02   ..|..Pv ..tg....
    0020 - 18 45 4d 35 17 01 b3 e5-5a d0 c4 f0 40 01 4b 84   .EM5....Z...@.K.
    0030 - 17 56 bb 7f 23 6c 8e 6c-de a0 3b 81 35 28 31 45   .V..#l.l..;.5(1E
    0040 - bf b9 e9 46 69 40 8a 92-3f c9 98 53 49 c4 a1 bc   ...Fi@..?..SI...
    0050 - d7 8d ed ef 1f 0f 87 e4-ee 74 09 4f 91 b1 43 3d   .........t.O..C=
    0060 - 7e 11 33 74 38 ee de 15-90 bf 9c e5 c9 31 7d 54   ~.3t8........1}T
    0070 - 55 08 71 f7 8c 55 7e 8e-cf b5 25 05 47 2e 9f 30   U.q..U~...%.G..0
    0080 - 8c a1 b7 f8 af 88 b7 0e-37 c3 e4 85 11 f7 26 40   ........7.....&@
    0090 - d9 bc 31 5d 6d 7d 80 dd-6c a6 7f 01 83 ae bb 3d   ..1]m}..l......=
    00a0 - fb 92 db 3c b8 c6 d8 8a-59 5c 1a f9 49 65 82 3e   ...<....Y\..Ie.>
    00b0 - ba 34 84 12 55 0b b7 32-f9 20 ac 1b 23 14 ed 12   .4..U..2. ..#...
    00c0 - ba 32 7d 54 37 62 b0 73-9e 13 8a b2 ab 5e c5 07   .2}T7b.s.....^..
    00d0 - 9f 41 0c e6 c7 93 00 eb-67 95 ef 5e 41 49 4c 76   .A......g..^AILv
    00e0 - cc aa 73 a0 d4 bb 1a e1-1b 1e ae 5d c9 09 c4 99   ..s........]....

    Start Time: 1638087404
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
    Max Early Data: 0
---
read R BLOCK
---
Post-Handshake New Session Ticket arrived:
SSL-Session:
    Protocol  : TLSv1.3
    Cipher    : TLS_AES_256_GCM_SHA384
    Session-ID: 3F88AAD8A540D9AF19077274747E178C87F6E25AB6434C82AF89C80824AFDB5D
    Session-ID-ctx: 
    Resumption PSK: 181AC16812B4A265D4A227999B027785FB8F62E78FA6D311ABCD79BE0FD834BFB3EBEA3622C7B152B48EE8096D7ACB6A
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    TLS session ticket lifetime hint: 300 (seconds)
    TLS session ticket:
    0000 - c8 15 e1 a8 12 82 4f b9-7d 02 5c 8c b9 63 bc 0d   ......O.}.\..c..
    0010 - 5b b3 5f e5 8c c1 89 58-89 5d a2 6f 8e c7 f4 f2   [._....X.].o....
    0020 - 3e 5c 8a 17 69 27 4e be-ff 38 23 d7 25 71 ee f5   >\..i'N..8#.%q..
    0030 - 30 57 22 e7 62 03 59 2c-4d 7b 14 75 33 d1 3e a1   0W".b.Y,M{.u3.>.
    0040 - 87 94 37 dd 60 19 65 54-5a a4 dd 54 1d 06 18 77   ..7.`.eTZ..T...w
    0050 - 1e c9 d1 6b 88 db eb 5d-30 51 02 2e c6 2f c2 c3   ...k...]0Q.../..
    0060 - 4b 89 16 99 05 af 01 ec-df fa 53 22 6e ad 8c 3d   K.........S"n..=
    0070 - e0 14 59 f0 50 ce 2e 46-70 6d c1 b6 79 4f fd 2e   ..Y.P..Fpm..yO..
    0080 - 34 fa 41 d8 b2 77 d9 6c-97 5f 67 bd fd 1a 53 0e   4.A..w.l._g...S.
    0090 - 88 d8 43 5b 9d d4 2e fc-05 f4 52 c9 ea b5 a4 48   ..C[......R....H
    00a0 - d1 ff 4a 85 73 4b c9 4e-66 b7 02 dc b7 4c 44 fa   ..J.sK.Nf....LD.
    00b0 - 0e b4 ed 6a 96 ae db ba-34 b2 01 f4 60 58 32 af   ...j....4...`X2.
    00c0 - 1d 69 bc 86 af be db f1-a8 0d 04 de de 16 f5 a6   .i..............
    00d0 - 3d 96 45 5e d4 a4 d8 64-a9 16 30 b7 37 3d 1c 86   =.E^...d..0.7=..
    00e0 - 81 ca 11 79 fc 9b 15 37-01 77 f1 07 42 d0 4c 11   ...y...7.w..B.L.

    Start Time: 1638087404
    Timeout   : 7200 (sec)
    Verify return code: 0 (ok)
    Extended master secret: no
    Max Early Data: 0
---
read R BLOCK
```

* ルートCAのDN：
     depth=2 C = JP, O = "SECOM Trust Systems CO.,LTD.", OU = Security Communication RootCA2
    depth=1 C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA
    depth=0 C = JP, ST = Tokyo, L = Chiyoda-ku, O = Ministry of Internal Affairs and Communications, jurisdictionC = JP, businessCategory = Government Entity, serialNumber = 2000012020001, OU = Ministry of Internal Affairs and Communications, CN = www.soumu.go.jp


* subject DN：
     subject=C = JP, ST = Tokyo, L = Chiyoda-ku, O = Ministry of Internal Affairs and Communications, jurisdictionC = JP, businessCategory = Government Entity, serialNumber = 2000012020001, OU = Ministry of Internal Affairs and Communications, CN = www.soumu.go.jp

* 発行者のDN：
     issuer=C = JP, O = "SECOM Trust Systems CO.,LTD.", CN = SECOM Passport for Web EV 2.0 CA

* TLSプロトコルのバージョン：Protocol  : TLSv1.3
* 暗号方式： TLS_AES_256_GCM_SHA384

## s_clientで代表的なTLSサーバの証明書を確認する

確認事項

* ルートCAのDN
* subject DN
* 発行者のDN
* TLSプロトコルのバージョン
* 暗号方式


### 飯塚市

```bash
openssl s_client -connect www.city.iizuka.lg.jp:443
```

### 東京都

```bash
openssl s_client -connect www.metro.tokyo.lg.jp:443
```

### 近畿大学

```bash
openssl s_client -connect www.kindai.ac.jp:443
```

### 三井住友銀行

```bash
openssl s_client -connect www.smbc.co.jp:443
```

### Google

```bash
openssl s_client -connect www.google.com:443
```

## TLSサーバの構築


```bash
sudo apt install apache2
```

### apache2 へのTLSの設定

```bash
sudo a2enmod ssl

sudo のパスワード: 

Considering dependency setenvif for ssl:
Module setenvif already enabled
Considering dependency mime for ssl:
Module mime already enabled
Considering dependency socache_shmcb for ssl:
Enabling module socache_shmcb.
Enabling module ssl.
See /usr/share/doc/apache2/README.Debian.gz on how to configure SSL and create self-signed certificates.
To activate the new configuration, you need to run:
  systemctl restart apache2
```

```bash
sudo a2ensite default-ssl
```

### apache2 の再起動

```bash
sudo  systemctl reload apache2
```

### ポート番号の確認

```
ss -lnt

State     Recv-Q     Send-Q          Local Address:Port          Peer Address:Port     
LISTEN    0          128             127.0.0.53%lo:53                 0.0.0.0:*        
LISTEN    0          128                   0.0.0.0:22                 0.0.0.0:*        
LISTEN    0          5                   127.0.0.1:631                0.0.0.0:*        
LISTEN    0          80                  127.0.0.1:3306               0.0.0.0:*        
LISTEN    0          128                      [::]:22                    [::]:*        
LISTEN    0          5                       [::1]:631                   [::]:*        
LISTEN    0          128                         *:443                      *:*        
LISTEN    0          128                         *:80                       *:*        

```

## TLSサーバの公開鍵証明書の発行

### DNの設計

* TLS サーバのCNは、FQDN
	ドメイン名が無い場合は、IPアドレス
	他は、CAと同じにする
* 管理者の電子メールアドレス

* 国＝日本の
	* C＝JP
* 州県＝福岡県の
	*  ST=Fukuoka
* 市＝飯塚市の
	* L=Iizuka
* 組織＝近畿大学の
	* O=Kindai University
* 部署＝班の名前
	* OU=Group X
* 標準名＝TLSサーバのドメイン名（IPアドレス）
	* CN=192.168.1.xx

### RSA鍵の生成

サーバ名を自分の名前にする

山崎の場合　→ yamasaki_server

```bash
openssl genrsa 2048 > yamasaki_server.key
```
### CSRの生成

```bash
openssl req -new -key yamasaki_server.key -out yamasaki_server.csr
```

##  証明書リクエストファイル (CSR) をCAに渡す
  
  demoCAのディレクトリにコピーするだけ
  
```
sudo cp yamasaki_server.csr /usr/lib/ssl/misc/
```
  
## CA として公開鍵証明書を作成する

CAのディレクトリに移動

```bash
cd /usr/lib/ssl/misc/
```

リクエストファイルを確認する

```bash
ls

yamasaki_server.csr
```

### CAとしてCSRに電子署名を行い、公開鍵証明書 （CRT)を作成する

```bash
sudo openssl ca -in yamasaki_server.csr -out yamasaki_server.crt
```

yesを２回入力すると成功

同じDNの証明書は再度作成できないので注意

### 公開鍵証明書の確認

```bash
openssl x509 -text -in yamasaki_server.crt 
```
発行者、主体名、有効期間、鍵の長さ、CAになれるか、などを確認

```
openssl x509 -text -in server.crt 
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            b6:72:ba:d7:a7:f1:d1:19
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: C = JP, ST = Fukuoka, O = Kindai University, OU = Group X, CN = Kindai CA
        Validity
            Not Before: Dec  2 08:47:47 2018 GMT
            Not After : Dec  2 08:47:47 2019 GMT
        Subject: C = JP, ST = Fukuoka, O = Kindai University, OU = Group X, CN = 192.168.0.17
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:a2:6b:5d:1b:0f:b9:d3:cd:10:da:ca:88:f0:98:
                    a6:bf:08:bf:ed:22:83:4f:2b:6f:3e:59:c6:2f:33:
                    3b:de:12:3e:8f:57:6a:bc:82:24:9d:82:36:fe:f0:
                    e3:ca:69:15:3b:7d:bf:c6:7e:6a:7a:94:7c:41:09:
                    1c:a8:c4:5a:a1:78:6d:79:0c:9d:33:00:61:6a:bf:
                    1d:94:95:79:01:67:1b:5f:7e:45:a5:3b:f3:cf:56:
                    9c:7f:db:9a:23:98:3a:5f:68:d8:bf:06:9f:a6:31:
                    26:6a:c7:92:ef:66:ff:fe:d7:54:87:16:51:b9:60:
                    e2:f7:4e:38:0b:36:95:e8:de:1f:a0:bd:c8:a0:6c:
                    e0:3e:db:f0:7e:b7:39:e5:78:86:af:4b:0d:4f:1a:
                    66:69:38:0e:9a:f4:67:7b:27:c4:4b:8a:65:27:c4:
                    74:d6:ab:87:a4:8c:9a:8f:ad:80:fd:86:c7:d1:10:
                    0c:be:d4:82:e2:e3:ef:e8:af:16:cd:6c:25:1f:d8:
                    7d:81:cf:20:bb:55:1d:f7:3d:93:f3:28:41:b5:19:
                    0c:ba:2f:69:2a:db:0f:13:b7:dd:d8:be:73:64:c8:
                    9e:a4:d0:d1:4b:be:a3:36:36:58:61:f7:e1:c4:01:
                    d6:67:52:89:79:fc:15:95:c8:bc:05:19:13:24:c9:
                    8f:f7
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                B4:8C:37:01:DD:BD:DA:69:14:B4:42:5B:80:BB:CF:51:AF:D3:10:16
            X509v3 Authority Key Identifier: 
                keyid:01:72:21:52:AF:00:EB:68:CF:AB:65:D1:54:FC:7E:AF:6A:A6:A0:89

    Signature Algorithm: sha256WithRSAEncryption
         0e:da:90:fd:ec:50:9c:f5:27:05:68:dd:b5:8a:99:bb:15:77:
         09:68:9e:8e:09:20:c5:99:c9:13:7b:3f:d5:3b:ec:d7:e8:dd:
         b6:e0:16:2d:e0:06:4f:9f:23:80:09:65:b8:80:8d:b7:df:c8:
         b0:f9:84:80:ba:6a:46:ad:73:51:63:83:d9:0b:60:c3:97:a1:
         a4:0d:e9:6f:17:43:ef:38:33:8f:4b:8d:03:44:8e:25:c0:61:
         37:b6:60:2c:65:49:e6:0d:13:58:fc:42:48:18:f7:36:14:f0:
         36:70:62:77:74:a8:32:9e:67:6b:b6:bb:77:68:36:cf:9d:6b:
         c5:da:41:69:fc:aa:1c:9e:16:28:70:d6:61:84:63:e2:7a:14:
         05:66:6e:71:47:42:3c:0a:a6:64:1c:7e:1a:c9:35:ec:78:8d:
         f0:32:e6:f9:aa:7f:fa:98:ed:c4:62:78:cb:20:7b:19:8a:31:
         1e:55:dd:cf:01:84:0f:05:51:59:6d:91:fb:3a:64:b0:71:b4:
         d2:69:8b:82:35:ba:a6:8d:b1:38:37:57:c2:18:81:bc:3d:20:
         93:6a:9a:df:68:6d:77:08:64:82:0b:81:96:fa:a6:19:ca:c2:
         3a:ec:a4:c1:c0:3f:df:db:6e:66:07:00:b1:92:2a:bc:4a:11:
         11:f0:54:46
-----BEGIN CERTIFICATE-----
MIIEHzCCAwegAwIBAgIJALZyuten8dEZMA0GCSqGSIb3DQEBCwUAMIGOMQswCQYD
VQQGEwJKUDEQMA4GA1UECAwHRnVrdW9rYTEaMBgGA1UECgwRS2luZGFpIFVuaXZl
cnNpdHkxPTA7BgNVBAsMNEZhY3VsdHkgb2YgSHVtYW5pdHkgT3JpZW50ZWQgU2Np
ZW5jZSBhbmQgRW5naW5lZXJpbmcxEjAQBgNVBAMMCUtpbmRhaSBDQTAeFw0xODEy
MDIwODQ3NDdaFw0xOTEyMDIwODQ3NDdaMIGRMQswCQYDVQQGEwJKUDEQMA4GA1UE
CAwHRnVrdW9rYTEaMBgGA1UECgwRS2luZGFpIFVuaXZlcnNpdHkxPTA7BgNVBAsM
NEZhY3VsdHkgb2YgSHVtYW5pdHkgT3JpZW50ZWQgU2NpZW5jZSBhbmQgRW5naW5l
ZXJpbmcxFTATBgNVBAMMDDE5Mi4xNjguMC4xNzCCASIwDQYJKoZIhvcNAQEBBQAD
ggEPADCCAQoCggEBAKJrXRsPudPNENrKiPCYpr8Iv+0ig08rbz5Zxi8zO94SPo9X
aryCJJ2CNv7w48ppFTt9v8Z+anqUfEEJHKjEWqF4bXkMnTMAYWq/HZSVeQFnG19+
RaU7889WnH/bmiOYOl9o2L8Gn6YxJmrHku9m//7XVIcWUblg4vdOOAs2lejeH6C9
yKBs4D7b8H63OeV4hq9LDU8aZmk4Dpr0Z3snxEuKZSfEdNarh6SMmo+tgP2Gx9EQ
DL7UguLj7+ivFs1sJR/YfYHPILtVHfc9k/MoQbUZDLovaSrbDxO33di+c2TInqTQ
0Uu+ozY2WGH34cQB1mdSiXn8FZXIvAUZEyTJj/cCAwEAAaN7MHkwCQYDVR0TBAIw
ADAsBglghkgBhvhCAQ0EHxYdT3BlblNTTCBHZW5lcmF0ZWQgQ2VydGlmaWNhdGUw
HQYDVR0OBBYEFLSMNwHdvdppFLRCW4C7z1Gv0xAWMB8GA1UdIwQYMBaAFAFyIVKv
AOtoz6tl0VT8fq9qpqCJMA0GCSqGSIb3DQEBCwUAA4IBAQAO2pD97FCc9ScFaN21
ipm7FXcJaJ6OCSDFmckTez/VO+zX6N224BYt4AZPnyOACWW4gI2338iw+YSAumpG
rXNRY4PZC2DDl6GkDelvF0PvODOPS40DRI4lwGE3tmAsZUnmDRNY/EJIGPc2FPA2
cGJ3dKgynmdrtrt3aDbPnWvF2kFp/KocnhYocNZhhGPiehQFZm5xR0I8CqZkHH4a
yTXseI3wMub5qn/6mO3EYnjLIHsZijEeVd3PAYQPBVFZbZH7OmSwcbTSaYuCNbqm
jbE4N1fCGIG8PSCTaprfaG13CGSCC4GW+qYZysI67KTBwD/f225mBwCxkiq8ShER
8FRG
-----END CERTIFICATE-----
```

## CAから申請者に完成した公開鍵証明書を渡す

証明書をCAのディレクトリから個人のディレクトリにコピーするだけ

```bash
cp yamasaki_server.crt ~/cert/
```


## 自分本人のディレクトリに移動

```bash
cd ~/cert
```

```bash
ls

cacert.pem  yamasaki_server.crt  yamasaki_server.key server.csr  ...
```

CAの公開鍵証明書、TLSサーバの公開鍵証明書、TLSサーバの秘密鍵、などがあることを確認
  
### TLSサーバ証明書の確認

 CAの公開鍵証明書をつかって自分の公開鍵証明書が正統なものであることを確認する

```
openssl verify -CAfile cacert.pem server.crt

server.crt: OK
```

## TLS公開鍵証明書とCA署名書をapacheに組み込む

### apacheのssl設定ファイルの修正

```bash
cd /etc/apache2/sites-enabled/
```

```bash
ls

000-default.conf  default-ssl.conf
```

apacheのssl設定ファイルの編集

```bash
sudo nano /etc/apache2/sites-enabled/default-ssl.conf
```

設定ファイルの修正箇所

* サーバ証明書のファイル名を yamasaki_server.crt にする
* サーバ秘密鍵のファイル名を yamasaki_server.key にする


★注意： SSLCertificateFile、SSLCertificateKeyFile、が他に無いか確認する

```
    ...
    
                SSLCertificateFile    /etc/ssl/certs/yamasaki_server.crt
                SSLCertificateKeyFile /etc/ssl/private/yamasaki_server.key
                
                #SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
                #   Server Certificate Chain:
                #   Point SSLCertificateChainFile at a file containing the
                #   concatenation of PEM encoded CA certificates which form the
                #   certificate chain for the server certificate. Alternatively
                #   the referenced file can be the same as SSLCertificateFile
                #   when the CA certificates are directly appended to the server
                #   certificate for convinience.
                
                # SSLCertificateChainFile /etc/apache2/cacert.pem   
                
                #   Certificate Authority (CA):
                #   Set the CA certificate verification path where to find CA
                #   certificates for client authentication or alternatively one
   
```

### 自分の証明書ディレクトリに復帰

```bash
cd ~/cert
```

### サーバ公開鍵証明書を組み込む

``
server.crt を /etc/ssl/certs/ ディレクトリにコピーする
``

```bash
sudo cp yamasaki_server.crt /etc/ssl/certs/
```

### サーバ秘密鍵を組み込む

``
server.key を/etc/ssl/private/ ディレクトリにコピーする
``

```bash
sudo cp yamasaki_server.key /etc/ssl/private/
```
### サーバ証明書検証チェーンのCAを組み込む

``
/etc/apache2/ssl.crt/ ディレクトリを作成する
``

```bash
sudo mkdir /etc/apache2/

sudo cp cacert.pem /etc/apache2/ssl.crt/
```


## TLSサーバを再起動する

```bash
sudo service apache2 restart
```


## openssl s_client で接続確認する

一旦 ログインサーバに戻る

```bash
exit
```

```bash
openssl s_client 192.168.2.<自分のマシン >:443
```

情報を確認してください

------------------ 以下は今回は無視 ------------------------

------------------ 以下は今回は無視 ------------------------

## ブラウザでサーバにアクセスする

``
https://192.168.0.17/signup.html
``
### ブラウザのエラー表示

![ブラウザのエラー表示](./images/nd1101.png)

### CA証明書をブラウザに組み込む

1. firefoxの「設定」を開く
2. 「ブラウザプライバシー」
3. 設定画面の一番下の右側の 「証明書を表示...」 
4. 「認証局証明書」のタブを選ぶ
5. 「読み込む」ボタンをクリック
6. homeディレクトリの下のcertディレクトリの下にある cacert.pem ファイルを組み込む

### あらためてブラウザでアクセスする

``
https://192.168.0.17/signup.html
``

正常にページが表示されることを確認する

## PKCS12形式の個人証明書のファイルを作成する

```bash
openssl pkcs12 -export -in yamasaki.crt -inkey yamasaki.key -out yamasaki.p12
```

## 人に対して自分のTLSサーバを信用させる

各自で方法を考えてください

### 例：CA証明書をwebで公開して信用させる

### 例：CA証明書をUSBで渡す

### 例：CA証明書をメールで渡す


