# ネットワークセキュリティ演習 4回 ファイアーウォール

最終更新 2022/09/18 Shigeichiro yamasaki


##  演習の目的と概要

* マシンのポートの開閉状況を確認する
* webサーバとmailサーバをインストールして稼働させ，ポートの状況の変化を確認する
* nmapコマンドによってポートスキャンを行う
* tcpdumpやwiresharkによるパケットキャプチャツールをインストールする
* バックドア検出ツールのchkrootkitを毎日起動するようにする
* Linuxカーネルのファイアーウォール機能である iptables の基本を学ぶ
* C言語のプログラムを動かす

## 演習の手順

* 1. 自分のマシンのポートの状況を確認する
* 2. webサーバのインストール
* 3. mail サーバ（SMTP）のインストール
* 4. nmapを使った他のマシンに対するポートスキャン
* 5. tcpdump
* 6. wireshark
* 7. chkrootkit バックドア検出ツール
* 8. iptables Linuxカーネルのファイアーウォール機能
* 9. C言語のプログラム入門

## システム構成

基本的に１台のマシンを各自が独立に操作して演習を行う．

## 1. 自分のマシンのポートの状況を確認する


#### 主なポート番号

|プロトコル|	ポート番号|
|----|----|
|HTTP|	80|
|HTTP(SSL)	|443|
|SMTP|	25|
|SMTP(SSL)|	465|
|POP3|	110|
|POP3(SSL)|	995|
|IMAP|	143|
|IMAP(SSL)|	993|
|SSH|	22|
|DNS| 53 (TCP/UDP)|
| NTP| 123|
| FTP| 20|
| FTP (制御)| 21|
|IDENT|   113|

### ss コマンド

通信が確立しているポートを表示する

```bash
$ ss -nltup
```

メモ保管しておく

### lsof コマンド

プロセスが使用しているポートを確認する

```bash
$ sudo lsof -c ssh
```

非常にたくさん出てきます．

## 2. webサーバのインストール

### apache2のインストールの確認

```bash
sudo apt install -y apache2
```

### webサーバのwebページを作成する

* webサーバマシンのindex.htmlファイルを修正

オリジナルをバックアップしておく

```bash
sudo mv /var/www/html/index.html /var/www/html/index.html.org
```

編集する

```bash
sudo nano /var/www/html/index.html
```

```html
<meta charset="UTF-8">
<html>
<head></head>
<body>
<h1>　（自分の名前）サーバ
</body>
</html>
```

### webサーバの確認

* IPアドレスを確認して，ブラウザからページが見えること

### ss コマンドでwebサーバが使用しているポートを確認する

```bash
$ ss -nltup
```

メモしておく

## 3. mail サーバ（SMTP）のインストール

### postfixのインストール

```bash
sudo apt install -y postfix
```

画面が出たら「インターネットサイト」を選択


#### mailコマンドのインストール

```bash
sudo apt install -y bsd-mailx
```

#### mailコマンドの確認


mail コマンドでメールを出してみる

```
$ mail kindai@localhost
```

```
Subject: test
Hello <自分の名前>

hello everyone!!!
.
Cc:
```

#### mailコマンドでメールを受信する

```
mail

Mail version 8.1.2 01/15/2001.  Type ? for help.
"/var/mail/hogeuser": 1 message 1 new
>N  1 hogeuser@sample.com   Fri Mar 24 12:32   14/429   test
& 1
Message 1:
From hogeuser@sample.com  Fri Mar 24 12:32:48 2017
X-Original-To: hogeuser@localhost
To: hogeuser@localhost
Subject: test
Date: Fri, 24 Mar 2017 12:32:48 +0900 (JST)
From: hogeuser@sample.com (hogeuser)

Hello <自分の名前>

& q
Saved 1 message in /home/hogeuser/mbox

```

### ss コマンドでwebサーバが使用しているポートを確認する

```bash
$ ss -nltup
```

先程との相違点を見つける
メモする

## 4. nmapを使った他のマシンへのポートスキャン

★★注意！！

サイトによってはポートスキャンをかけること自体が攻撃になります．
演習用のマシン以外にはポートスキャンをかけることは慎みましょう．
攻撃者とみなされる可能性もあります．

### nmapのインストール

```bash
$ sudo apt install -y nmap
```

#### nmapで対象マシンのポートの開き状態を確認する

```bash
nmap <IPアドレス>
```

#### nmapで自分自身のポートの開き状態を確認する

```bash
$ nmap localhost
```

|STATE|	説明|
|----|----|
|open|	そのポートで何らかの待ち受けが行われている（ポートが開いている）|
|closed|	ポートにアクセス可能だが待ち受けを行っているアプリケーションはない（ポートが閉じられている）|
|filtered|	そのポートに対しパケットフィルタが適用されており、ポートが利用できるかを判断できない|
|unfiltered	|ポートへのアクセスは可能だが、ポートが開いているかどうかは判断できない|
|open \| filtered|	ポートは開いている、もしくはパケットフィルタが適用されているが、そのどちらかは判断できない|
|closed \| filtered|	ポートは閉じられている、もしくはパケットフィルタが適用されているが、そのどちらかは判断できない|


```
Starting Nmap 7.60 ( https://nmap.org ) at 2019-10-06 15:22 JST
Nmap scan report for localhost (127.0.0.1)
Host is up (0.000011s latency).
Not shown: 998 closed ports
PORT    STATE SERVICE
22/tcp  open  ssh
631/tcp open  ipp
```

#### 開いているポートをメモしてください


### nmapで同じセグメントのネットワークのマシンに対するポートスキャン

数分〜10分以上かかりまるので，このターミナルはほうっておいて，次の作業をすすめていきます．

```bash
nmap -A 192.168.1.0/24
```

* ポートスキャンした内容をチェックしてみる
* スキャンして見つけたIPアドレスに対してOSやソフトのバージョン情報を調べる
* 使用されていないアドレスは、[host down]　と表示される


### ステルススキャン

相手にさとられずにポートスキャンする

sudo が必要

```bash
sudo nmap -sA 192.168.2.0/24
```

* OSのバージョン
* 稼働しているソフトのバージョンをメモしてください

### grep コマンド

出力中の文字列に対して文字列のパターンを使って検索し表示する

nmap の出力の中で一定のパタンを持つものだけを出力する例

```
nmap -v 192.168.1.0/24 | grep 192.168.
```


## 5. tcpdump

ネットワーク通信の生のデータをキャプチャして出力してくれるツール

### tcpdump をインストールする

```bash
sudo apt install -y tcpdump
```

|オプション	|意味|
|----|----|
|-i [interface]|	インターフェースを指定してキャプチャ|
|-w [filename]|	[filename]で指定したファイルにキャプチャ結果を書き出す|
|-r [filename]|	tcpdumpでとったキャプチャ結果を読み込む|
|-A	|キャプチャデータをASCIIで表示|
|-p	|自ホスト宛以外のデータはキャプチャしない（非プロミスキャスモード）|


### TCPをモニターする (22)

停止は  (ctrl)-c

```bash
$ sudo tcpdump -A port 22

```

#### curl コマンドでweb にアクセス

```bash
$ curl www.kindai.ac.jp
```

### TCPをモニターする（ssh 22番ポート）

```bash
$ sudo tcpdump -A port 80
```


tcpdumpの出力を確認してみる

## 6. wireshark

インストールする

```bash
$ sudo apt install -y wireshark
```

インストール途中で、「スーパーユーザー以外もWiresharkを使うか？」と尋ねられます。
「はい」を選択し、Enterキー

### デスクトップのアイコンをダブルクリック

まずデスクトップの左下の以下のようなアイコンをクリック

```
●●●
●●●
●●●
```
![](https://tarufu.info/wp-content/uploads/2020/12/wireshark_install002.png)

パーミッションの変更など

```bash
$ sudo dpkg-reconfigure wireshark-common
```

「はい」

```bash
$ sudo chmod +x /usr/bin/dumpcap
```

## 7. chkrootkit バックドア検出ツール

バックドアを構築するソフトのことをルートキットという

ルートキットを検出するツール

ルートキット検出ツールのインストール

```bash
sudo apt install -y chkrootkit
```

チェック

```
sudo chkrootkit
```

### chkrootkitを毎日自動起動する

#### cron を利用して時刻で自動起動する

```bash
sudo crontab -u root -e
```

毎日　0時0分にチェックする

```

0 0 * * * /usr/sbin/chkrootkit
```


## 8. iptables Linuxカーネルのファイアーウォール機能


### iptables の設定の確認


```bash
sudo iptables -L
```

```
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
cafe@techcafe:~$ 

```

## 9. C言語のプログラム入門

### C言語コンパイラのインストール

GCC は前回インストール済

```bash
sudo apt install -y gcc
```

別のC 言語処理系

```bash
sudo apt install -y clang
```
	

### C言語開発用のディレクトリの作成

```bash
mkdir c

cd c
```

### 最初のCプログラム


hello.c

```bash
nano hello.c
```
	

```c
#include <stdio.h>
int main(void){
  puts("hello hello hello");
  return 0;
}
```

### コンパイル

* gcc の場合

```bash
gcc hello.c
```

```bash
ls
a.out  hello.c
```

* clang の場合

```bash
clang hello.c
```

```bash
ls
a.out  hello.c
```

### コンパイルした実行ファイルの実行

```bash
./a.out
hello hello hello
```

### fileコマンド

ELF ファイル（Linuxの実行ファイル）の確認

アーキテクチャ，エンディアンなどの確認

```
file a.out

a.out: ELF 64-bit LSB pie executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID[sha1]=d6509b95374ea2c1e05ba69bd411b6c7d62a85a2, for GNU/Linux 3.7.0, not stripped
```

### 逆アセンブラ

```
objdump -d a.out

a.out:     file format elf64-littleaarch64


Disassembly of section .init:

00000000000005d0 <_init>:
 5d0:	d503245f 	bti	c
 5d4:	a9bf7bfd 	stp	x29, x30, [sp, #-16]!
 5d8:	910003fd 	mov	x29, sp
 5dc:	94000038 	bl	6bc <call_weak_fn>
 5e0:	a8c17bfd 	ldp	x29, x30, [sp], #16
 5e4:	d65f03c0 	ret

Disassembly of section .plt:

...

```

