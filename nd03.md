# ネットワークセキュリティ演習  3回 利用者認証／認可とアクセス制御

最終更新 2022/09/17 Shigeichiro yamasaki

##  演習の目的と概要

* 利用者認証に関連する暗号技術とその脅威を知る
    * 暗号学的ハッシュ関数の利用法理解
    * パスワードファイルの仕組みの理解
    * パスワードクラッカーの仕組みの理解
    * レインボーテーブルの利用方法
    * キーロガーの仕組み理解
* 利用者管理の方法を知る
    * シェルスクリプトの文法と使い方
    * シェルスクリプトを利用したユーザ登録と削除
* ディレクトリのアクセス管理の方法を知る
    * 組織のポリシーの設計に基づいてディレクトリのパーミッションを定義する

## 演習の手順

* 1. ユーザ作成の復習
* 2. 暗号学的ハッシュ関数の実行
* 3. ファイルシステムの情報を確認する
* 4. LinuxのユーザIDとグループID
* 5. ファイルのパーミッション
* 6. ファイルシステムのアクセス制御の実験

## システム構成

基本的に１台のマシンを各自が独立に操作して演習を行う．



## 1. ユーザ作成の復習 (adduserコマンド）

```bash
sudo adduser kindai

新しい UNIX パスワードを入力してください: 
新しい UNIX パスワードを再入力してください: 
passwd: パスワードは正しく更新されました
user2 のユーザ情報を変更中
新しい値を入力してください。標準設定値を使うならリターンを押してください
	フルネーム []: 
	部屋番号 []: 
	職場電話番号 []: 
	自宅電話番号 []: 
	その他 []: 
以上で正しいですか? [Y/n] y

```

## 2. 暗号学的ハッシュ関数の実行

nano エディタでメッセージを作成

```bash
nano message
```


```nano
hello Kindai

[ 新しいファイル ]
^G ヘルプ    ^O 書き込み  ^W 検索      ^K 切り取り  ^J 均等割付  ^C カーソル位置
^X 終了      ^R 読み込み  ^\ 置換      ^U 貼り付け  ^T スペル確認^_ 行を指定
```

保存: コントロールO、 エンターキー

終了：コントロールX

### SHA256によるmessageのハッシュ値の計算

```bash
sha256sum message

78b3245df318fef83622196bb9d2de215905014afa1d73e1bc99818fc6b2cfbf  message
```

### opensslコマンドによる SHA256のハッシュ

同じになることを確認してください

```bash
openssl sha256 message

SHA256(message)= 78b3245df318fef83622196bb9d2de215905014afa1d73e1bc99818fc6b2cfbf
```

### ファイルを使わずに echo コマンドと | （パイプ）で実行する方法

パイプは複数のプロセスをファイルの標準出力／入力として連結する機能

echo コマンドは python の print文

```bash
echo 'hello Kindai' 
hello Kindai
```

```bash
echo 'hello Kindai' | sha256sum
78b3245df318fef83622196bb9d2de215905014afa1d73e1bc99818fc6b2cfbf  -


echo 'hello Kindai' | openssl sha256
(stdin)= 78b3245df318fef83622196bb9d2de215905014afa1d73e1bc99818fc6b2cfbf
```



### SHA3-256によるmessageのハッシュ値の計算


opensslコマンドを使う場合

```bash
 openssl sha3-256 message
SHA3-256(message)= ec5d8eb39eb3656a067b66f4c224d6b9b6168ff3293cdd31fe5ce0328ee96031

```

## パスワードファイルの確認

### /ect/passwd の内容

```bash
cat /etc/passwd
```

ユーザ名がubuntuのところを見つける

### /etc/shadow の内容の確認

```bash
sudo cat /etc/shadow
```

ユーザ名が kindai のところを見つける

grep コマンドを使うと指定した文字列を含む行だけを出力してくれる

パイプライン '|' を使うと、前のコマンドの実行結果を次のコマンドの入力にしてくれる

```bash
sudo cat /etc/shadow 
# たくさんの結果が出力される

sudo cat /etc/shadow |grep kindai

# 結果
kindai:$6$p5rz5WEL$z3l9Idyl2mmXPHDRw5oh.m2jPseeoV5QnUtV3NNCWmXjqrOxwQy2ozziSM0VKRO6PE8NNvrdVGjEGFX0YkQLv1:18531:0:99999:7:::
```

$6$ は、暗号学的ハッシュ関数として　SHA512 を使っているという意味

## パスワードクラッカー

/etc/passwdのクラックツール「John The Ripper」を使ってみる

### John the Ripperをインストール

```bash
sudo apt install john
```

### John the Ripperのテスト

暗号技術ごとのベンチマークが出る

```bash
john --test

# ベンチマークの結果
```

### わざと弱いパスワードにする

ubuntuが備えている標準的な英語の辞書ファイル
/usr/share/dict/words
にある英単語を利用

```bash
cat /usr/share/dict/words
```

```bash
cat /usr/share/dict/words | grep eggplant
```

### クラック対象のユーザを作成する


```bash
sudo adduser userx

# パスワードにeggplant を入れてみる
```

userx にログインしてみる

```bash
su userx
パスワード: 


exit
```

### /etc/shadow を解析可能にする

 John the Ripper　の unshadowコマンドを利用する

unshadowコマンドで，/etc/passwd と /etc/shadow を結合する
```
sudo  unshadow /etc/passwd /etc/shadow > p.txt
```

```bash
cat p.txt

...
userx:$6$gwI/YsiN$zaWxZdZpiqfcvFEQzohYeXGvI/d1ivBOLwm1p0bSiOA4O11tCXEPe3o/uR348QPpq.pu1ZG/zUAYI/tMXwihj.:1001:1001:,,,:/home/userx:/bin/bash
```
### johnコマンドを実行

ubuntuが備えている標準的な英語の辞書ファイルを使ってパスワードを調べる

```
john p.txt
```

発見したパスワードを表示する

```bash
john --users=userx --show p.txt

userx:eggplant:1003:1006:,,,:/home/userx:/bin/bash

1 password hash cracked, 0 left
```


## Rainbow Table

レインボーテーブル無料配布サイトURL

[http://project-rainbowcrack.com/table.htm](http://project-rainbowcrack.com/table.htm)

### dcipher-cli のインストール

AWS ではポートが塞がれているので失敗します．

```bash
sudo apt update
sudo apt upgrade -y
sudo apt install -y npm
sudo npm install -y -g dcipher-cli
```

### パスワードのSHA-256のハッシュ値をdcipher-cli で攻撃してみる

一般の乱数に比べて，10文字程度のアルファベットと数字の組み合わせは圧倒的に小さな空間になる．

（echo -n は改行を入れないという意味）

数字やアルファベットのみのパスワードの場合


```
# iloveyou123456 というパスワードの SHA-256 ハッシュの場合

echo -n iloveyou123456 | sha256sum
06f1fdc4ddbd21cbfdbe838c91f50d740207a7b3e6fe7539387e4888fc24fd13  -

# SHA-256ハッシュ値の原像を求める
dcipher 06f1fdc4ddbd21cbfdbe838c91f50d740207a7b3e6fe7539387e4888fc24fd13
✔ iloveyou123456

# あいうえお というひらがな文字列のパスワードの SHA-256 ハッシュの場合

echo -n あいうえお | sha256sum                       
fdb481ea956fdb654afcc327cff9b626966b2abdabc3f3e6dbcb1667a888ed9a

# SHA-256ハッシュ値の原像を求める
dcipher fdb481ea956fdb654afcc327cff9b626966b2abdabc3f3e6dbcb1667a888ed9a
✔ あいうえお
```

パスワードにアルファベットと数字に特殊文字を混ぜた場合

```
echo -n iloveyou#123 | sha256sum
d48fc0d4f0ebb9101fc8f1f5cf2ef43212a4d7e1521c1ac31246e1a45af0ba69  -

dcipher d48fc0d4f0ebb9101fc8f1f5cf2ef43212a4d7e1521c1ac31246e1a45af0ba69
✖ Hash could not be deciphered

```

## キーロガー

linuxのキーロガーをインストールする

他人が自分のマシンを使った形跡を調べるのにも利用可能

logkeys のインストール

```bash
sudo apt install -y autoconf
sudo apt install -y make
sudo apt install -y gcc
sudo apt install -y git

git init
git clone https://github.com/kernc/logkeys

cd logkeys
./autogen.sh
cd build
../configure
make
sudo make install 
```

USBキーボードのイベント情報をしらべる

```bash
cat /proc/bus/input/devices
```

出てくる結果の中で、Name= ** USB Keyboad ** というところを調べる

```bash
I: Bus=0003 Vendor=1c4f Product=0027 Version=0110
N: Name="SIGMACHIP USB Keyboard"
P: Phys=usb-0000:00:14.0-4.2/input0
S: Sysfs=/devices/pci0000:00/0000:00:14.0/usb1/1-4/1-4.2/1-4.2:1.0/0003:1C4F:0027.0002/input/input5
U: Uniq=
H: Handlers=sysrq kbd event5 leds 
B: PROP=0
B: EV=120013
B: KEY=1000000000007 ff800000000007ff febeffdff3cfffff fffffffffffffffe
B: MSC=10
B: LED=7
```

この中の H: のところ

```
Handlers=sysrq kbd event5 leds 
```

の場所をみると event5 になっている
各自のマシンで異なるeventの場合もある

### キーロガーを起動する

最後の event5 は、上記のevetを指定している
各自で異なる場合がある

logtest.txt は、キーボードイベントの記録用ファイル

```bash
sudo logkeys -s -o ~/logtest.txt -d /dev/input/event5
```

### キーロガーを停止する

停止する前にキーボードを操作しておく


```bash
sudo logkeys -k
```

### キーのログを確認する

```bash
sudo cat logtest.txt
```


## シェルスクリプト

### シェルスクリプトとはコマンドを自動実行するファイル

コマンドを実行してみる

```bash
date

2022年  9月  3日 土曜日 13:34:51 JST
```


簡単なシェルスクリプトをnanoエディタで作成する

date コマンドを実行するシェルスクリプトを jikoku.sh という名前で作成する

```bash
nano jikoku.sh
```

内容
１行名は、かならず #!/bin/bash

```bash
#!/bin/bash
date
```

### シェルスクリプトに実行権限を与える

```bash
chmod 770 jikoku.sh
```

### 作成したシェルスクリプトを実行する

いまこのディレクトリ（カレントディレクトリ）を ./ と書く

```
./jikoku.sh
```

### 200人のユーザをつくる(１)

```bash
nano add_students.sh
```


```bash
#!/bin/bash                                                                             
i=1
n=200
while [ $i -le $n ];
do
  echo "gaksei$i"
  i=`expr $i + 1`
done
```

実行権限を与える

```
chmod 770 add_students.sh
```

```
./add_students.sh
```

### 200人の学生ユーザをつくる(2)

```
nano add_students.sh 
```

★useradd -m を使う

```
#!/bin/bash                                                                             
i=1
n=200
while [ $i -le $n ];
do
  echo "gaksei$i"
  sudo useradd -m  "gakusei$i"
  i=`expr $i + 1`
done
```

実行権限を与える

```
chmod 770 add_students.sh
```

```
sudo ./add_students.sh
```

### 200人の学生ユーザとディレクトリを削除する

```bash
nano del_students.sh
```

```bash
#!/bin/bash                                                                             
i=1
n=200
while [ $i -le $n ];
do
  echo "gaksei$i"
  userdel -r "gakusei$i"
  i=`expr $i + 1`
done

```

実行権限を与える


```bash
chmod 770 del_students.sh
```

```bash
sudo ./del_students.sh
```

### 学生のプライマリグループをstudentにする

再度ユーザ作成

```
./add_students.sh
```

```bash
nano mod_students.sh
```

```
#!/bin/bash                                                                             
i=1
n=200
while [ $i -le $n ];
do
  echo "gakusei$i"
  sudo usermod -g student "gakusei$i" 
  i=`expr $i + 1`
done
```

```
sudo chmod 770 mod_students.sh
./mod_students.sh
```
### 最初の100人の学生を情報学科グループに

```bash
sudo groupadd joho
```

```bash
nano joho_students.sh
```

```bash
#!/bin/bash                                                                             
i=1
n=100
while [ $i -le $n ];
do
  echo "gakusei$i"
  sudo usermod -G joho "gakusei$i" 
  i=`expr $i + 1`
done

```

実行権限を与える

```
chmod 770 joho_students.sh
```

```
./joho_students.sh
```


### 情報学科の２0人を「情報エンジニア」の履修生に

```bash
groupadd engineer
```

```bash
nano eng_students.sh
```

```bash
#!/bin/bash                                                                             
i=1
n=20
while [ $i -le $n ];
do
  sudo usermod -G joho,engineer "gakusei$i" 
  i=`expr $i + 1`
done
```

ディレクトリの実行権限を与える

```bash
chmod 770 eng_students.sh
```

```
./nstudents.sh
```

### 情報学科の学生と教員のみがアクセスできるディレクトリを作成

演習用ディレクトリ作成

```bash
mkdir /tmp/enshu2/
```

情報学科用ディレクトリ作成

```
mkdir /tmp/enshu2/joho
```

情報学科学生用ディレクトリ作成

```bash
mkdir /tmp/enshu2/joho/students
```




