# ネットワークセキュリティ演習 14回  プライバシ保護技術1

最終更新 2022/12/11 Shigeichiro yamasaki

##  演習の目的と概要

* 個人情報を匿名加工によって流通可能なデータに変換する
* ミクロアグリゲーションによる匿名加工の演習
* K-匿名性による匿名加工
* 匿名加工の精度の向上


## 演習の手順

1. 個人情報である映画の視聴履歴のアンケートに回答する
2. 類似度を表す Tanimoto 係数の計算の練習
3. 個人データのCSVデータファイルの加工
4. 仮名加工
5. 仮名加工情報による Tanimoto係数の計算
6. 隣接する２人ずつの平均値によるミクロアグリゲーション法による匿名加工
7. 匿名加工情報による Tanimoto係数の計算
8. K-匿名性の評価
9. 人間の間の類似度

## システム構成

各自のマシンを利用

## 1. 個人情報である映画の視聴履歴のアンケートに回答する

未回答の方のみ

[https://docs.google.com/forms/d/1mrCc0oyDLoZc_KfDNESEQmjYo8HTb-5oNfYhw630Azw/](https://docs.google.com/forms/d/1mrCc0oyDLoZc_KfDNESEQmjYo8HTb-5oNfYhw630Azw/)



## 2. 類似度を表すtanimoto係数の計算の練習

映画の視聴データからtanimoto係数による映画の間の「距離」を求める

### 基本的なアプローチ

* 配列要素になる2つのデータの mv[n][(1..-1)] （映画名 mv[n][0] を除いたデータ）についてtanimoto係数を計算するメソッドをmapメソッドで適用
* その結果を得る
* 最も類似度が高いもの（距離が1.0 に近いもの）を見つける

###  映画視聴データ



```bash
$ irb
```

テストデータ

```ruby
mv= [["ジョーズ", 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], ["紅の豚", 0, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0], ["サマーウォーズ", 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 0], ["時をかける少女", 0, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1], ["グレイテストショーマン", 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1], ["風立ちぬ", 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1], ["ノーゲイム・ノーライフ", 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 1, 0, 0, 1], ["シンゴジラ", 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0], ["ゼログラビティ", 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1], ["アナと雪の女王", 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1], ["君の名は", 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0], ["タイタニック", 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1], ["ベイマックス", 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1], ["ミニオンズ", 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 1, 1], ["美女と野獣", 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1]]

```


#### 映画ごとのデータを取り出す

```ruby
mv[0]
mv[0][0]

mv[1]
mv[1][0]

mv[2]
mv[2][0]

mv[3]
mv[3][0]
```

#### 1の個数を数える

```ruby
mv[0].count(1)
mv[1].count(1)
mv[2].count(1)
mv[3].count(1)

```

#### ２つの配列をzip して共通集合を確認する

[1,1] になっているところが両方の映画を見ている人がいるということ

```ruby
# mv[0] と mv[0] をzip した配列を作成
mv[0].zip(mv[1])
```

他の組み合わせも確認する

```
mv[1].zip(mv[2])
mv[2].zip(mv[3])
```

両方の映画を見ている数

```ruby
mv[1][0]
=> "紅の豚"
mv[2][0]
=> "サマーウォーズ"

mv[1].count(1)
=> 54
mv[2].count(1)
=> 62


# 紅の豚とサマーウォーズ
mv[1].zip(mv[2]).count([1,1])
=> 46
```

#### tanimoto係数を計算するメソッド

2つの集合 A B のTanimoto係数

Tanimoto係数 = A,Bの共通集合の要素数／A,B の和集合の要素数
             = A,Bの共通集合の要素数／(Aの要素数+Bの要素数 - A,Bの共通集合の要素数)

##### 紅の豚とサマーウォーズのTanimoto係数

```ruby
# 紅の豚を見た人の数
na = mv[1].count(1)
# サマーウォーズを見た人の数
nb = mv[2].count(1)
# 紅の豚とサマーウォーズを見た人の数
nab = mv[1].zip(mv[2]).count([1,1])
# Tanimoto係数
tanimoto = nab/(na+nb-nab).to_f

=> 0.6571428571428571
```

##### tanimoto係数メソッド(数値の配列だけの比較をする)

```ruby
# 誰も見ていない映画は集合要素数 0 であることに注意

def tanimoto(a,b)
  na=a.count(1)
  nb=b.count(1)
  nab=a.zip(b).count([1,1])
  # 分母が0の場合はTanimoto係数 0.0
  if (na+nb-nab) == 0 then
    t = 0.0
  else
    t = nab/(na+nb-nab).to_f
  end
  return t
end
```

### ジョーズと紅の豚の視聴者の類似度

```ruby
mv[0][0]
=> "ジョーズ"

mv[1][0]
=> "紅の豚"

tanimoto(mv[0],mv[1])
=> 0.26666666666666666
```

### ジョーズと他の映画の視聴者の類似度

```ruby
mv.map{|m| tanimoto(mv[0],m)}
 
=> [1.0, 0.26666666666666666, 0.3125, 0.3333333333333333, 0.11538461538461539, 0.41025641025641024, 0.275, 0.16666666666666666, 0.2, 0.29411764705882354, 0.4117647058823529]
```

#### 映画名を出す

```ruby
mv.map{|m| [mv[0][0],m[0],tanimoto(mv[0],m)]}

=> 
[["ジョーズ", "ジョーズ", 1.0],
 ["ジョーズ", "紅の豚", 0.26666666666666666],
 ["ジョーズ", "サマーウォーズ", 0.3125],
 ["ジョーズ", "時をかける少女", 0.3333333333333333],
 ["ジョーズ", "グレイテストショーマン", 0.11538461538461539],
 ["ジョーズ", "風立ちぬ", 0.41025641025641024],
 ["ジョーズ", "ノーゲイム・ノーライフ", 0.275],
 ["ジョーズ", "シンゴジラ", 0.16666666666666666],
 ["ジョーズ", "ベイマックス", 0.2],
 ["ジョーズ", "ミニオンズ", 0.29411764705882354],
 ["ジョーズ", "美女と野獣", 0.4117647058823529]]
 
#  類似度が高い順にソートする
mv.map{|m| [mv[0][0],m[0],tanimoto(mv[0],m)]}.sort_by{|x|x[2]}.reverse

=> 
[["ジョーズ", "ジョーズ", 1.0],                                                                
 ["ジョーズ", "美女と野獣", 0.4117647058823529],                                               
 ["ジョーズ", "風立ちぬ", 0.41025641025641024],                                                
 ["ジョーズ", "時をかける少女", 0.3333333333333333],                                           
 ["ジョーズ", "サマーウォーズ", 0.3125],                                                       
 ["ジョーズ", "ミニオンズ", 0.29411764705882354],                                              
 ["ジョーズ", "ノーゲイム・ノーライフ", 0.275],                                                
 ["ジョーズ", "紅の豚", 0.26666666666666666],                                                  
 ["ジョーズ", "ベイマックス", 0.2],                                                            
 ["ジョーズ", "シンゴジラ", 0.16666666666666666],                                              
 ["ジョーズ", "グレイテストショーマン", 0.11538461538461539]]        
```

### 全映画の組み合わせに対する tanimoto係数（類似度）を求める

```ruby
sim = mv.map{|x|mv.map{|y|[x[0],y[0],tanimoto(x,y)]}.sort_by{|x|x[2]}.reverse}

sim
```

### 映画ごとの類似度が高いもの３つを知る

```ruby
sim[3][1..3]

=> [["時をかける少女", "サマーウォーズ", 0.696969696969697], ["時をかける少女", "紅の豚", 0.6], ["時をかける少女", "ノーゲイム・ノーライフ", 0.49056603773584906]]
```

### ここまでの処理をメソッド化する

```ruby
# 全映画の組み合わせに対する tanimoto係数（類似度）を求める
def sim_mx(mv)
     mv.map{|x|mv.map{|y|[x[0],y[0],tanimoto(x,y)]}.sort_by{|x|x[2]}.reverse}
end

```


## 3. 個人データCSVデータファイルの加工

csv形式テストデータのファイル（個人データ）

[test.csv](./test.csv)

[mv2022.csv](./mv2022.csv)


リンクをクリックし，ファイルを自分のマシンのホームディレクトリに保存してください


### 個人データのファイルを読み込んで見る

```ruby
# CSVファイルをオープン
f=File.open('./test.csv')
# 文字列として内容を読み込む
string = f.read
# 文字列を整形する（余計な改行記号を消すなど）
wfstring = string.gsub("\r",'')
# データを改行記号 "\n" で分割
row = wfstring.split("\n")
# 確認
row
# 1行目を確認（カラム０：タイムスタンプ, カラム１：メールアドレス であることを確認する）
row[0]

=> "タイムスタンプ,メールアドレス,ジョーズ,紅の豚,サマーウォーズ,時をかける少女,グレイテストショーマン,風立ちぬ,ノーゲイム・ノーライフ,シンゴジラ,ゼログラビティ,アナと雪の女王,君の名は,タイタニック,ベイマックス,ミニオンズ,美女と野獣,ナルニア国物語,少林サッカー,探偵はbarにいる,シェイプオブウォーター,聲の形,言の葉の庭,マレフィセント,アナコンダ,ピンポン,時計じかけのオレンジ,シャイニング,図書館戦争,英国王のスピーチ,羊たちの沈黙,プレデターズ,猿の惑星,寄生獣,レッドクリフ,キングスマン,アメリカン・スナイパー,天使にラブソングを,アルマゲドン,フォレストガンプ,インターステラー,フルメタル・ジャケット,ジョニーは戦場へ行った,戦慄の楽譜,アオハライド,ララランド,シックスセンス,バタフライ・エフェクト,はじまりのうた,パシフィックリム,セブン,本能寺ホテル,インセプション,アイ、ロボット,マトリックス,土竜の唄,アントマン,未来のミライ,シンドラーのリスト,エクス・マキナ,海猿,デスノート,オブリビオン,あゝ荒野,バクマン。,ひるね姫 ～知らないワタシの物語～,イミテーションゲーム,舟を編む,ガールズ＆パンツァー 劇場版,ストロベリーナイト,海街diary,トイ・ストーリー,プラダを着た悪魔,きっと、うまくいく,海月姫"

# 各配列要素の文字列を , で区切った配列に分割し，行列（配列の配列）にする
matrix = row.map{|r|r.split(",")}

# 内容の確認
matrix[0][0]

=> "タイムスタンプ"

 matrix[0][1]
=> "メールアドレス"

matrix[0][2]
=> "ジョーズ"

matrix[2][2]
=> "0"

# データ部分の "0" を整数 0 に，"1" を整数 1に置き換える
priv_matrix = [matrix[0]] + matrix[1..-1].map{|row|row[0..1] + row[2..-1].map{|x|x.to_i}}

# タイムスタンプのカラムは不要
priv_mx = priv_matrix.transpose[1..-1].transpose
```

### 個人データのマトリックスを確認

メールアドレスで個人が識別可能な個人データであることを確認します．

```ruby
priv_mx[0]

priv_mx[1]

priv_mx[2]
```

### ここまでの処理をメソッドにする

```ruby
def priv_mx(file)
    f=File.open(file){|f|
        wfstring = f.read.gsub("\r",'')
        matrix = wfstring.split("\n").map{|r|r.split(",")}
        priv_matrix = [matrix[0]] + matrix[1..-1].map{|row|row[0..1] + row[2..-1].map{|x|x.to_i}}
        return priv_mx = priv_matrix.transpose[1..-1].transpose
    }
end

# 実行
priv_mx =  priv_mx('./test.csv')

# 確認
priv_mx[0]
priv_mx[1]
priv_mx[2]
```

### 行列の行と列を転置して，映画ごとのデータにする

```ruby
priv_mx_t = priv_mx.transpose

# 確認
priv_mx_t[0]
priv_mx_t[1]
priv_mx_t[2]
priv_mx_t[3]
```

## 4. 仮名加工

仮名加工によって個人データを個人との直接的な接続性なくす

### メールアドレスを削除する

```ruby
pseudo_mx_t = priv_mx_t[1..-1]

# 確認
pseudo_mx_t[0]
pseudo_mx_t[1]
pseudo_mx_t[2]
```

### さらに行をシャッフルして，登録順と個人との関連を消す

```ruby
pmv = pseudo_mx_t.shuffle

# 確認
pmv
pmv[0]
pmv[1]
pmv[2]
```

### 仮名加工した行列を転置してCSVファイルとして保存する

```ruby
# ２次元配列を文字列に変換
pcsv_string = pmv.transpose.map{|row|row.join(',')}.join("\n")

# ファイルに保存
File.open('./pseuso_mv.csv','w'){|f|f.write(pcsv_string)}
```

別のターミナルから確認

```bash
$ ~
$ cat pseuso_mv.csv
```

このファイルは，組織内では自由に利用できる
第三者提供は，原則として委託契約が必要
共同利用という方法も可能

★仮名加工情報からの再識別を行う行為は禁止されている（違法行為）



## 5. 仮名加工情報による Tanimoto係数の計算

```ruby
psim = sim_mx(pmv)
```

### 映画ごとの類似度が高いものを３つ表示する

この映画を見ている人はこの映画も見ている

```ruby
# 映画ごとの類似度が高いものNを知る
def topN(n,sim)
    sim.map{|m|[m[0][0]] + [m[1..n].map{|y|y[1]}]}.sort_by{|x|x[0]}
end

```

##### 類似している映画トップ３を調べる

```ruby
ptop3 = topN(3,psim)

=> 
[["あゝ荒野", ["あゝ荒野", "はじまりのうた", "セブン"]],
 ["きっと、うまくいく", ["セブン", "シンドラーのリスト", "フォレストガンプ"]],
 ["はじまりのうた", ["シェイプオブウォーター", "あゝ荒野", "時計じかけのオレンジ"]],
 ["ひるね姫 ～知らないワタシの物語～", ["英国王のスピーチ", "インセプション", "エクス・マキナ"]],
 ["アイ、ロボット", ["ひるね姫 ～知らないワタシの物語～", "英国王のスピーチ", "プラダを着た悪魔"]],
 ["アオハライド", ["土竜の唄", "寄生獣", "プレデターズ"]],
 ["アナと雪の女王", ["トイ・ストーリー", "君の名は", "紅の豚"]],
 ["アナコンダ", ["マレフィセント", "英国王のスピーチ", "タイタニック"]],
 ["アメリカン・スナイパー", ["タイタニック", "アルマゲドン", "パシフィックリム"]],
 ["アルマゲドン", ["プレデターズ", "海猿", "アントマン"]],
 ["アントマン", ["マレフィセント", "アルマゲドン", "図書館戦争"]],
 ["イミテーションゲーム", ["エクス・マキナ", "戦慄の楽譜", "海月姫"]],
 ["インセプション", ["英国王のスピーチ", "ひるね姫 ～知らないワタシの物語～", "インターステラー"]],
 ["インターステラー", ["インセプション", "シェイプオブウォーター", "本能寺ホテル"]],
 ["エクス・マキナ", ["きっと、うまくいく", "セブン", "イミテーションゲーム"]],
 ["オブリビオン", ["きっと、うまくいく", "セブン", "フォレストガンプ"]],
 ["ガールズ＆パンツァー 劇場版", ["フルメタル・ジャケット", "言の葉の庭", "グレイテストショーマン"]],
 ["キングスマン", ["インセプション", "はじまりのうた", "英国王のスピーチ"]],
 ["グレイテストショーマン", ["舟を編む", "ピンポン", "シェイプオブウォーター"]],
 ["サマーウォーズ", ["トイ・ストーリー", "時をかける少女", "紅の豚"]],
 ["シェイプオブウォーター", ["はじまりのうた", "舟を編む", "グレイテストショーマン"]],
 ["シックスセンス", ["エクス・マキナ", "ジョニーは戦場へ行った", "戦慄の楽譜"]],
 ["シャイニング", ["言の葉の庭", "イミテーションゲーム", "ララランド"]],
 ["シンゴジラ", ["ゼログラビティ", "アントマン", "風立ちぬ"]],
 ["シンドラーのリスト", ["きっと、うまくいく", "セブン", "オブリビオン"]],
 ["ジョニーは戦場へ行った", ["シックスセンス", "エクス・マキナ", "戦慄の楽譜"]],
 ["ジョーズ", ["プレデターズ", "美女と野獣", "風立ちぬ"]],
 ["ストロベリーナイト", ["戦慄の楽譜", "フルメタル・ジャケット", "きっと、うまくいく"]],
 ["セブン", ["セブン", "シンドラーのリスト", "フォレストガンプ"]],
 ["ゼログラビティ", ["ララランド", "アントマン", "レッドクリフ"]],
 ["タイタニック", ["アメリカン・スナイパー", "マトリックス", "ジョーズ"]],
 ["デスノート", ["トイ・ストーリー", "サマーウォーズ", "時をかける少女"]],
 ["トイ・ストーリー", ["紅の豚", "アナと雪の女王", "サマーウォーズ"]],
 ["ナルニア国物語", ["サマーウォーズ", "ミニオンズ", "紅の豚"]],
 ["ノーゲイム・ノーライフ", ["時をかける少女", "アナと雪の女王", "サマーウォーズ"]],
 ["バクマン。", ["言の葉の庭", "デスノート", "未来のミライ"]],
 ["バタフライ・エフェクト", ["セブン", "きっと、うまくいく", "羊たちの沈黙"]],
 ["パシフィックリム", ["プレデターズ", "マトリックス", "アルマゲドン"]],
 ["ピンポン", ["グレイテストショーマン", "海街diary", "舟を編む"]],
 ["フォレストガンプ", ["セブン", "きっと、うまくいく", "エクス・マキナ"]],
 ["フルメタル・ジャケット", ["インセプション", "はじまりのうた", "きっと、うまくいく"]],
 ["プラダを着た悪魔", ["ひるね姫 ～知らないワタシの物語～", "セブン", "きっと、うまくいく"]],
 ["プレデターズ", ["アルマゲドン", "猿の惑星", "時をかける少女"]],
 ["ベイマックス", ["トイ・ストーリー", "アナと雪の女王", "ミニオンズ"]],
 ["マトリックス", ["パシフィックリム", "海猿", "猿の惑星"]],
 ["マレフィセント", ["アントマン", "美女と野獣", "図書館戦争"]],
 ["ミニオンズ", ["トイ・ストーリー", "アナと雪の女王", "君の名は"]],
 ["ララランド", ["ゼログラビティ", "マトリックス", "図書館戦争"]],
 ["レッドクリフ", ["インセプション", "ゼログラビティ", "英国王のスピーチ"]],
 ["君の名は", ["トイ・ストーリー", "紅の豚", "アナと雪の女王"]],
 ["図書館戦争", ["アントマン", "マレフィセント", "海猿"]],
 ["土竜の唄", ["アオハライド", "海街diary", "図書館戦争"]],
 ["天使にラブソングを", ["アナと雪の女王", "ミニオンズ", "タイタニック"]],
 ["寄生獣", ["デスノート", "君の名は", "サマーウォーズ"]],
 ["少林サッカー", ["紅の豚", "サマーウォーズ", "トイ・ストーリー"]],
 ["戦慄の楽譜", ["イミテーションゲーム", "ストロベリーナイト", "シックスセンス"]],
 ["探偵はbarにいる", ["海街diary", "ジョニーは戦場へ行った", "戦慄の楽譜"]],
 ["時をかける少女", ["サマーウォーズ", "トイ・ストーリー", "アナと雪の女王"]],
 ["時計じかけのオレンジ", ["あゝ荒野", "はじまりのうた", "セブン"]],
 ["未来のミライ", ["言の葉の庭", "図書館戦争", "ノーゲイム・ノーライフ"]],
 ["本能寺ホテル", ["アントマン", "インターステラー", "土竜の唄"]],
 ["海月姫", ["イミテーションゲーム", "ひるね姫 ～知らないワタシの物語～", "英国王のスピーチ"]],
 ["海猿", ["アルマゲドン", "プレデターズ", "マトリックス"]],
 ["海街diary", ["ピンポン", "土竜の唄", "探偵はbarにいる"]],
 ["猿の惑星", ["プレデターズ", "風立ちぬ", "マトリックス"]],
 ["紅の豚", ["トイ・ストーリー", "サマーウォーズ", "君の名は"]],
 ["羊たちの沈黙", ["バタフライ・エフェクト", "英国王のスピーチ", "インセプション"]],
 ["美女と野獣", ["風立ちぬ", "アルマゲドン", "ナルニア国物語"]],
 ["聲の形", ["君の名は", "トイ・ストーリー", "ミニオンズ"]],
 ["舟を編む", ["言の葉の庭", "グレイテストショーマン", "シェイプオブウォーター"]],
 ["英国王のスピーチ", ["ひるね姫 ～知らないワタシの物語～", "インセプション", "エクス・マキナ"]],
 ["言の葉の庭", ["舟を編む", "未来のミライ", "バクマン。"]],
 ["風立ちぬ", ["デスノート", "時をかける少女", "猿の惑星"]]]
```


## 6. 隣接する２人ずつの平均値によるミクロアグリゲーション法による匿名加工


### 個人データ（人を行にしたデータ）

あらためてファイルから読みこむ

```ruby
priv_matrix =  priv_mx('./test.csv')
```

### 隣接する２人の平均をとる

```ruby
# 隣接する二人のデータ
priv_matrix[1].zip(priv_matrix[2])

# 隣接する二人のデータの平均値
priv_matrix[1].zip(priv_matrix[2])[2..-1].map{|x|(x[0]+x[1])/2.0}

=> [0.0, 0.0, 1.0, 0.5, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.5, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.5, 0.0, 0.5, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0]
```

### この平均値でtanimoto係数を計算できるか？

* これまでのものは、1か0かしか扱えない
* 共通集合の定義ができなくなる

### 拡張したtanimoto係数


![](http://chart.apis.google.com/chart?cht=tx&chl=T%28A%2CB%29%3D%5Cfrac%7B%5Csum%28x_%7BAk%7D%2Ax_%7BBk%7D%29%7D%7B%5Csum%20x%5E2_%7BAk%7D%20%2B%20%5Csum%20x%5E2_%7BBk%7D%20-%20%5Csum%20%28x_%7BAk%7D%2Ax_%7BBk%7D%29%7D)

```ruby
def tanimotoF(a,b)
    sa=a.map{|x|x**2}.sum.to_f
    sb=b.map{|x|x**2}.sum.to_f
    sab=a.zip(b).map{|x|x[0]*x[1]}.sum.to_f
    if (sa+sb-sab) == 0.0 then
        t = 0.0
    else
        t = sab/(sa+sb-sab)
    end
    return t
end
```

#### 確かめてみる

```ruby
tanimoto(mv[1],mv[3])
=> 0.6
tanimotoF(mv[1][1..-1],mv[3][1..-1])
=> 0.6
```

### priv_matrixを二人ずつの平均データにする

Ruby のeach_cons(n)メソッド （配列から重複ありで n 個ずつ取り出す）を利用

```ruby
[0, 4, 5, 7, 9, 32].each_cons(2){|x|p x}

[0, 4]
[4, 5]                                                                               
[5, 7]                                                                               
[7, 9]                                                                               
[9, 32] 

# Ruby には map_cons は無いので Array クラスのメソッドとして追加する
class Array
  def map_cons(n)
    out=[]
    self.each_cons(n){|x|out << yield(x)}
    out
  end
end

[0, 4, 5, 7, 9, 32].map_cons(2){|x|x}

=> [[0, 4], [4, 5], [5, 7], [7, 9], [9, 32]]
```

隣接する二人ずつの平均

```ruby
pairs = priv_matrix[1..-1].map_cons(2){|x|x}

pairs[0]

# 隣接する二人のデータの平均値
averages = pairs[0][0].zip(pairs[0][1])[2..-1].map{|x|(x[0]+x[1])/2.0}

=> [0.0, 0.0, 1.0, 0.5, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.5, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.5, 0.0, 0.5, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0]
```

### 隣接する二人ずつのデータの平均による匿名加工データの作成

```ruby
def anonymize1(priv_matrix)
    pairs = priv_matrix[1..-1].map_cons(2){|x|x}
    [priv_matrix[0][1..-1]] + pairs.map{|p|p[0].zip(p[1])[1..-1].map{|x|(x[0]+x[1])/2.0}}
end

# 二人ずつのデータの平均による匿名加工
anonym_matrix =  anonymize1(priv_matrix)
```

### 匿名加工データを転置して映画ごとのデータにする

```ruby
amv = anonym_matrix.transpose

amv[0]
amv[1]
```

### 匿名加工した映画ごとのデータをCVSファイルとして保存する

このファイルは匿名加工情報なので，第三者譲渡などが可能です


```ruby
# ２次元配列を文字列に変換
acsv_string = amv.transpose.map{|row|row.join(',')}.join("\n")

# ファイルに保存
File.open('./anonym_mv.csv','w'){|f|f.write(acsv_string)}
```

別ターミナルで確認

```bash
$ cd ~
$ cat anonym_mv.csv
```


## 7. 匿名加工情報による Tanimoto係数の計算

拡張 tanimoto係数に対応させたメソッド

```ruby
# 全映画の組み合わせに対する拡張 tanimoto係数（類似度）を求める
def sim_mxF(mv)
     mv.map{|x|mv.map{|y|[x[0],y[0],tanimotoF(x[1..-1],y[1..-1])]}.sort_by{|x|x[2]}.reverse}
end
```

### Tanimoto係数の計算

```ruby
asim = sim_mxF(amv)

asim
asim[0]
asim[1]
```

##### 類似している映画トップNを調べる

```ruby
atop3 = topN(3,asim)

=> 
[["あゝ荒野", ["あゝ荒野", "セブン", "きっと、うまくいく"]],
 ["きっと、うまくいく", ["セブン", "バタフライ・エフェクト", "フォレストガンプ"]],
 ["はじまりのうた", ["シェイプオブウォーター", "あゝ荒野", "英国王のスピーチ"]],
 ["ひるね姫 ～知らないワタシの物語～", ["英国王のスピーチ", "インセプション", "エクス・マキナ"]],
 ["アイ、ロボット", ["パシフィックリム", "英国王のスピーチ", "羊たちの沈黙"]],
 ["アオハライド", ["寄生獣", "バクマン。", "プレデターズ"]],
 ["アナと雪の女王", ["トイ・ストーリー", "君の名は", "サマーウォーズ"]],
 ["アナコンダ", ["グレイテストショーマン", "図書館戦争", "アントマン"]],
 ["アメリカン・スナイパー", ["アルマゲドン", "タイタニック", "パシフィックリム"]],
 ["アルマゲドン", ["プレデターズ", "マトリックス", "海猿"]],
 ["アントマン", ["マレフィセント", "図書館戦争", "美女と野獣"]],
 ["イミテーションゲーム", ["エクス・マキナ", "戦慄の楽譜", "シャイニング"]],
 ["インセプション", ["インターステラー", "英国王のスピーチ", "ひるね姫 ～知らないワタシの物語～"]],
 ["インターステラー", ["インセプション", "シェイプオブウォーター", "英国王のスピーチ"]],
 ["エクス・マキナ", ["セブン", "きっと、うまくいく", "イミテーションゲーム"]],
 ["オブリビオン", ["きっと、うまくいく", "セブン", "バタフライ・エフェクト"]],
 ["ガールズ＆パンツァー 劇場版", ["フルメタル・ジャケット", "ジョーズ", "マトリックス"]],
 ["キングスマン", ["インセプション", "英国王のスピーチ", "ひるね姫 ～知らないワタシの物語～"]],
 ["グレイテストショーマン", ["舟を編む", "ピンポン", "英国王のスピーチ"]],
 ["サマーウォーズ", ["トイ・ストーリー", "時をかける少女", "紅の豚"]],
 ["シェイプオブウォーター", ["はじまりのうた", "グレイテストショーマン", "フルメタル・ジャケット"]],
 ["シックスセンス", ["エクス・マキナ", "ジョニーは戦場へ行った", "フルメタル・ジャケット"]],
 ["シャイニング", ["イミテーションゲーム", "ララランド", "戦慄の楽譜"]],
 ["シンゴジラ", ["風立ちぬ", "ゼログラビティ", "ジョーズ"]],
 ["シンドラーのリスト", ["セブン", "きっと、うまくいく", "バタフライ・エフェクト"]],
 ["ジョニーは戦場へ行った", ["シックスセンス", "エクス・マキナ", "探偵はbarにいる"]],
 ["ジョーズ", ["プレデターズ", "風立ちぬ", "美女と野獣"]],
 ["ストロベリーナイト", ["戦慄の楽譜", "シャイニング", "フルメタル・ジャケット"]],
 ["セブン", ["セブン", "バタフライ・エフェクト", "フォレストガンプ"]],
 ["ゼログラビティ", ["ララランド", "アントマン", "マトリックス"]],
 ["タイタニック", ["マトリックス", "デスノート", "ジョーズ"]],
 ["デスノート", ["時をかける少女", "アナと雪の女王", "サマーウォーズ"]],
 ["トイ・ストーリー", ["アナと雪の女王", "サマーウォーズ", "君の名は"]],
 ["ナルニア国物語", ["サマーウォーズ", "ミニオンズ", "紅の豚"]],
 ["ノーゲイム・ノーライフ", ["時をかける少女", "アナと雪の女王", "デスノート"]],
 ["バクマン。", ["アオハライド", "言の葉の庭", "寄生獣"]],
 ["バタフライ・エフェクト", ["フォレストガンプ", "きっと、うまくいく", "セブン"]],
 ["パシフィックリム", ["マトリックス", "アルマゲドン", "海猿"]],
 ["ピンポン", ["グレイテストショーマン", "海街diary", "舟を編む"]],
 ["フォレストガンプ", ["バタフライ・エフェクト", "セブン", "きっと、うまくいく"]],
 ["フルメタル・ジャケット", ["シックスセンス", "シェイプオブウォーター", "インセプション"]],
 ["プラダを着た悪魔", ["アナコンダ", "ひるね姫 ～知らないワタシの物語～", "バタフライ・エフェクト"]],
 ["プレデターズ", ["猿の惑星", "少林サッカー", "時をかける少女"]],
 ["ベイマックス", ["ミニオンズ", "トイ・ストーリー", "アナと雪の女王"]],
 ["マトリックス", ["少林サッカー", "アルマゲドン", "パシフィックリム"]],
 ["マレフィセント", ["アントマン", "図書館戦争", "美女と野獣"]],
 ["ミニオンズ", ["アナと雪の女王", "トイ・ストーリー", "君の名は"]],
 ["ララランド", ["ゼログラビティ", "風立ちぬ", "シャイニング"]],
 ["レッドクリフ", ["ゼログラビティ", "インセプション", "タイタニック"]],
 ["君の名は", ["トイ・ストーリー", "アナと雪の女王", "サマーウォーズ"]],
 ["図書館戦争", ["アントマン", "マレフィセント", "土竜の唄"]],
 ["土竜の唄", ["図書館戦争", "未来のミライ", "ノーゲイム・ノーライフ"]],
 ["天使にラブソングを", ["パシフィックリム", "タイタニック", "アメリカン・スナイパー"]],
 ["寄生獣", ["デスノート", "アナと雪の女王", "聲の形"]],
 ["少林サッカー", ["紅の豚", "サマーウォーズ", "時をかける少女"]],
 ["戦慄の楽譜", ["イミテーションゲーム", "ストロベリーナイト", "シックスセンス"]],
 ["探偵はbarにいる", ["本能寺ホテル", "海街diary", "アントマン"]],
 ["時をかける少女", ["サマーウォーズ", "紅の豚", "アナと雪の女王"]],
 ["時計じかけのオレンジ", ["あゝ荒野", "セブン", "きっと、うまくいく"]],
 ["未来のミライ", ["言の葉の庭", "図書館戦争", "土竜の唄"]],
 ["本能寺ホテル", ["探偵はbarにいる", "英国王のスピーチ", "図書館戦争"]],
 ["海月姫", ["英国王のスピーチ", "イミテーションゲーム", "ひるね姫 ～知らないワタシの物語～"]],
 ["海猿", ["少林サッカー", "アルマゲドン", "マトリックス"]],
 ["海街diary", ["ピンポン", "図書館戦争", "アントマン"]],
 ["猿の惑星", ["プレデターズ", "風立ちぬ", "少林サッカー"]],
 ["紅の豚", ["トイ・ストーリー", "サマーウォーズ", "時をかける少女"]],
 ["羊たちの沈黙", ["英国王のスピーチ", "バタフライ・エフェクト", "ひるね姫 ～知らないワタシの物語～"]],
 ["美女と野獣", ["風立ちぬ", "アントマン", "デスノート"]],
 ["聲の形", ["アナと雪の女王", "ミニオンズ", "君の名は"]],
 ["舟を編む", ["言の葉の庭", "グレイテストショーマン", "ピンポン"]],
 ["英国王のスピーチ", ["ひるね姫 ～知らないワタシの物語～", "羊たちの沈黙", "インセプション"]],
 ["言の葉の庭", ["舟を編む", "未来のミライ", "バクマン。"]],
 ["風立ちぬ", ["プレデターズ", "デスノート", "猿の惑星"]]]

```

### 仮名加工のものと比較してみる

N位までの仮名加工情報との一致比率

かなり違っていることがわかります

```ruby
def precision(n,asim,psim)
    s = psim.size.to_f
    d = (topN(n,asim)-topN(n,psim)).size
    return (s-d)/s
end
```

* 3位までの一致比率

```ruby
precision(3,asim,psim)
=> 0.0958904109589041
```

* 2位までの一致比率

```ruby
precision(2,asim,psim)
=> 0.3424657534246575
```


* 1位までの一致比率

```ruby
precision(1,asim,psim)
=> 0.547945205479452
```

#### 不一致の内容

```ruby
 topN(3,asim)-topN(3,psim)
 
=> 
[["あゝ荒野", ["あゝ荒野", "セブン", "きっと、うまくいく"]],
 ["きっと、うまくいく", ["セブン", "バタフライ・エフェクト", "フォレストガンプ"]],
 ["はじまりのうた", ["シェイプオブウォーター", "あゝ荒野", "英国王のスピーチ"]],
 ["アイ、ロボット", ["パシフィックリム", "英国王のスピーチ", "羊たちの沈黙"]],
 ["アオハライド", ["寄生獣", "バクマン。", "プレデターズ"]],
 ["アナと雪の女王", ["トイ・ストーリー", "君の名は", "サマーウォーズ"]],
 ["アナコンダ", ["グレイテストショーマン", "図書館戦争", "アントマン"]],
 ["アメリカン・スナイパー", ["アルマゲドン", "タイタニック", "パシフィックリム"]],
 ["アルマゲドン", ["プレデターズ", "マトリックス", "猿の惑星"]],
 ["アントマン", ["マレフィセント", "図書館戦争", "美女と野獣"]],
 ["イミテーションゲーム", ["エクス・マキナ", "戦慄の楽譜", "シャイニング"]],
 ["インセプション", ["インターステラー", "英国王のスピーチ", "ひるね姫 ～知らないワタシの物語～"]],
 ["インターステラー", ["インセプション", "シェイプオブウォーター", "英国王のスピーチ"]],
 ["オブリビオン", ["セブン", "きっと、うまくいく", "バタフライ・エフェクト"]],
 ["ガールズ＆パンツァー 劇場版", ["フルメタル・ジャケット", "ジョーズ", "マトリックス"]],
 ["キングスマン", ["インセプション", "英国王のスピーチ", "ひるね姫 ～知らないワタシの物語～"]],
 ["グレイテストショーマン", ["舟を編む", "ピンポン", "英国王のスピーチ"]],
 ["シェイプオブウォーター", ["はじまりのうた", "グレイテストショーマン", "フルメタル・ジャケット"]],
 ["シックスセンス", ["エクス・マキナ", "ジョニーは戦場へ行った", "フルメタル・ジャケット"]],
 ["シャイニング", ["イミテーションゲーム", "ララランド", "戦慄の楽譜"]],
 ["シンゴジラ", ["風立ちぬ", "ゼログラビティ", "ジョーズ"]],
 ["ジョニーは戦場へ行った", ["シックスセンス", "エクス・マキナ", "探偵はbarにいる"]],
 ["ジョーズ", ["プレデターズ", "風立ちぬ", "美女と野獣"]],
 ["ストロベリーナイト", ["戦慄の楽譜", "シャイニング", "アナコンダ"]],
 ["セブン", ["セブン", "バタフライ・エフェクト", "フォレストガンプ"]],
 ["ゼログラビティ", ["ララランド", "アントマン", "マトリックス"]],
 ["タイタニック", ["マトリックス", "デスノート", "ジョーズ"]],
 ["デスノート", ["時をかける少女", "アナと雪の女王", "サマーウォーズ"]],
 ["トイ・ストーリー", ["アナと雪の女王", "紅の豚", "君の名は"]],
 ["ナルニア国物語", ["ミニオンズ", "サマーウォーズ", "紅の豚"]],
 ["ノーゲイム・ノーライフ", ["時をかける少女", "アナと雪の女王", "デスノート"]],
 ["バクマン。", ["アオハライド", "言の葉の庭", "寄生獣"]],
 ["バタフライ・エフェクト", ["フォレストガンプ", "きっと、うまくいく", "セブン"]],
 ["パシフィックリム", ["マトリックス", "アルマゲドン", "海猿"]],
 ["フォレストガンプ", ["バタフライ・エフェクト", "セブン", "きっと、うまくいく"]],
 ["フルメタル・ジャケット", ["シックスセンス", "シェイプオブウォーター", "インセプション"]],
 ["プラダを着た悪魔", ["アナコンダ", "ひるね姫 ～知らないワタシの物語～", "バタフライ・エフェクト"]],
 ["プレデターズ", ["少林サッカー", "猿の惑星", "時をかける少女"]],
 ["ベイマックス", ["ミニオンズ", "トイ・ストーリー", "アナと雪の女王"]],
 ["マトリックス", ["少林サッカー", "アルマゲドン", "パシフィックリム"]],
 ["マレフィセント", ["アントマン", "図書館戦争", "美女と野獣"]],
 ["ミニオンズ", ["アナと雪の女王", "トイ・ストーリー", "君の名は"]],
 ["ララランド", ["ゼログラビティ", "風立ちぬ", "シャイニング"]],
 ["レッドクリフ", ["ゼログラビティ", "インセプション", "英国王のスピーチ"]],
 ["君の名は", ["トイ・ストーリー", "アナと雪の女王", "サマーウォーズ"]],
 ["図書館戦争", ["アントマン", "マレフィセント", "土竜の唄"]],
 ["土竜の唄", ["図書館戦争", "未来のミライ", "ノーゲイム・ノーライフ"]],
 ["天使にラブソングを", ["パシフィックリム", "タイタニック", "マトリックス"]],
 ["寄生獣", ["デスノート", "アナと雪の女王", "聲の形"]],
 ["少林サッカー", ["紅の豚", "サマーウォーズ", "時をかける少女"]],
 ["探偵はbarにいる", ["本能寺ホテル", "海街diary", "アントマン"]],
 ["時をかける少女", ["サマーウォーズ", "紅の豚", "アナと雪の女王"]],
 ["時計じかけのオレンジ", ["あゝ荒野", "セブン", "きっと、うまくいく"]],
 ["未来のミライ", ["言の葉の庭", "図書館戦争", "土竜の唄"]],
 ["本能寺ホテル", ["探偵はbarにいる", "英国王のスピーチ", "アントマン"]],
 ["海月姫", ["英国王のスピーチ", "イミテーションゲーム", "ひるね姫 ～知らないワタシの物語～"]],
 ["海猿", ["少林サッカー", "アルマゲドン", "マトリックス"]],
 ["海街diary", ["ピンポン", "アントマン", "図書館戦争"]],
 ["猿の惑星", ["プレデターズ", "風立ちぬ", "アルマゲドン"]],
 ["紅の豚", ["トイ・ストーリー", "サマーウォーズ", "時をかける少女"]],
 ["羊たちの沈黙", ["英国王のスピーチ", "バタフライ・エフェクト", "ひるね姫 ～知らないワタシの物語～"]],
 ["美女と野獣", ["風立ちぬ", "アントマン", "デスノート"]],
 ["聲の形", ["アナと雪の女王", "ミニオンズ", "君の名は"]],
 ["舟を編む", ["言の葉の庭", "グレイテストショーマン", "ピンポン"]],
 ["英国王のスピーチ", ["ひるね姫 ～知らないワタシの物語～", "羊たちの沈黙", "インセプション"]],
 ["風立ちぬ", ["プレデターズ", "デスノート", "猿の惑星"]]]

```

#### 課題

匿名加工の推薦精度をもっと向上させて仮名加工情報に近づける方法を検討してください


## 8. K-匿名性に基づく匿名化

仮名加工情報から K-匿名性の問題があるデータを削除する

### 一人しか見ていない映画を調べる (K=2  としたとき）

K=1 のとき，映画から人が特定できてしまう．
K=2 のとき，候補者は２名しかいないので，訴訟リスクは残る．

```ruby
k_risky = pmv
    .map{|row|[row.count(1),row[0]]}
    .select{|r|r[0]==1}
    .reduce([]){|s,x|s<<x[1]}

=> ["時計じかけのオレンジ", "あゝ荒野"]
```

この映画に関する情報を仮名加工情報から削除して，匿名加工情報にする

```ruby
ksafe_mv = pmv.reject{|row|row.count(1)==1}
```

## 9. 人間の間の類似度

```ruby
priv_mx

simp = sim_mx(priv_mx[1..-1])

simp
simp[0]
```

### 似ている人の組み合わせ Top1

* ランダムに人のペアを作って平均をとるよりも，似ている人の平均をとったミクロアグリゲーションの方が推薦精度が向上するかも？



```ruby
topN(1,simp)

=> 
[["1", ["63"]],
 ["10", ["26"]],
 ["11", ["12"]],
 ["12", ["11"]],
 ["13", ["7"]],
 ["14", ["10"]],
 ["15", ["4"]],
 ["16", ["23"]],
 ["17", ["39"]],
 ["18", ["5"]],
 ["19", ["46"]],
 ["2", ["76"]],
 ["20", ["35"]],
 ["21", ["70"]],
 ["22", ["65"]],
 ["23", ["48"]],
 ["24", ["70"]],
 ["25", ["29"]],
 ["26", ["60"]],
 ["27", ["46"]],
 ["28", ["43"]],
 ["29", ["25"]],
 ["3", ["64"]],
 ["30", ["38"]],
 ["31", ["19"]],
 ["32", ["21"]],
 ["33", ["46"]],
 ["34", ["9"]],
 ["35", ["9"]],
 ["36", ["29"]],
 ["37", ["22"]],
 ["38", ["35"]],
 ["39", ["42"]],
 ["4", ["15"]],
 ["40", ["59"]],
 ["41", ["35"]],
 ["42", ["51"]],
 ["43", ["28"]],
 ["44", ["9"]],
 ["45", ["35"]],
 ["46", ["19"]],
 ["47", ["5"]],
 ["48", ["23"]],
 ["49", ["15"]],
 ["5", ["18"]],
 ["50", ["61"]],
 ["51", ["42"]],
 ["52", ["79"]],
 ["53", ["13"]],
 ["54", ["18"]],
 ["55", ["68"]],
 ["56", ["65"]],
 ["57", ["51"]],
 ["58", ["37"]],
 ["59", ["44"]],
 ["6", ["60"]],
 ["60", ["26"]],
 ["61", ["65"]],
 ["62", ["42"]],
 ["63", ["48"]],
 ["64", ["44"]],
 ["65", ["22"]],
 ["66", ["28"]],
 ["67", ["9"]],
 ["68", ["12"]],
 ["69", ["9"]],
 ["7", ["13"]],
 ["70", ["21"]],
 ["71", ["25"]],
 ["72", ["43"]],
 ["73", ["13"]],
 ["74", ["29"]],
 ["75", ["9"]],
 ["76", ["26"]],
 ["77", ["24"]],
 ["78", ["61"]],
 ["79", ["52"]],
 ["8", ["27"]],
 ["9", ["75"]]]
```
