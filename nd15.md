# Google Photos OAuth API

## Google Photos API の有効化

Google loginして次のページにアクセス

[Add the magic of Google Photos to your app](https://developers.google.com/photos)

#####  Start buildingボタンをクリック

![](https://2.bp.blogspot.com/-timwxCTbb5I/XcDUmfMAHcI/AAAAAAAAIPA/_AC5nnb0QbwfUiJLU9SZgHArHE9FpWyEQCNcBGAsYHQ/s1600/gphoto1.png)

##### 左のプレーンのGet started with RESTを選択

##### Enable the Google Photos Library API ボタンをクリック

Google Photos Library APIを有効にするアプリの名前を登録します。

![](https://4.bp.blogspot.com/-UO7DHYyXDB8/XcDUmQckX7I/AAAAAAAAIPI/pDJmFeIpZg4wh9FdsyBHK7rQuoKNkB93gCNcBGAsYHQ/s1600/gphoto2.png)

名前を「Kindai-photos」にします

#### Configure your OAuth client

Web-browserを選択します（URLは入力しなくてよいです）

![](https://3.bp.blogspot.com/-J7g0_fJzLBg/XcDUmW9MOSI/AAAAAAAAIPE/31ALcNGEduwCHG6-xkSWjFQMZJ_BI_tbACNcBGAsYHQ/s1600/gphoto3.png)

#### 「CREATE」をクリック

#### APIが有効になります。（Client IDとClient Secretはまだ不十分な状態です）

![](https://4.bp.blogspot.com/-a8ZiqSawILM/XcDUnYwzOJI/AAAAAAAAIPQ/7hnHSxhAQbw-mAKEkfMP_yJcYlYYt1g9ACNcBGAsYHQ/s1600/gphoto5.png)

#### DONE をクリックして終了

## Google API　コンソールに移動

[APIとサービス画面に移動](https://console.cloud.google.com/apis/dashboard?pli=1&project=oauth-testr-338806)


### プロジェクトの選択

ブルーのバーにあるプロジェクト名部分を選択して「新しいプロジェクト」を作成

プロジェクト名を「Kinda-photos」にする

#### 左のプレーンの「認証情報」を選択

「OAuth client」というクライアントが作成されているのを確認

![](https://4.bp.blogspot.com/-fpX1oTKEGqY/XcDYIWix7pI/AAAAAAAAIPo/WtJW4f2FEgAr3lrQMJBpdRaEFhjb9u_9ACNcBGAsYHQ/s1600/gphoto6.png)


#### JSONをダウンロードをクリックしてダウンロード

ダウンロードしたファイルを「client_secrets.json」にする

#### 鉛筆のアイコンをクリックしてウェブ アプリケーション のクライアント IDを編集

#### 承認済のリダイレクトURLを入力（+URIを追加）

http://localhost:9292/redirect

#### 保存をクリック

#### OAuth同意画面を確認しておく

## Rubyでの開発（sinatraというフレームワークを利用）

```
gem install sinatra

gem install google-api-client
```

### サンプル

```bash
cd ~
nano config.ru
```

config.ru

```ruby
require './app'
run TestWebApp
```

```bash
nano app.rb
```

app.rb

```ruby
require 'sinatra/base'
require 'google/api_client/client_secrets'
require 'json'
require 'net/https'

class TestWebApp < Sinatra::Base
  enable :sessions

  before do
    client_secrets = Google::APIClient::ClientSecrets.load
    @auth_client = client_secrets.to_authorization
  end

  get '/' do
    @auth_client.update!(
      :redirect_uri => 'http://localhost:9292/redirect',
      :scope => [
        'https://www.googleapis.com/auth/photoslibrary.readonly',
        'https://www.googleapis.com/auth/photoslibrary.readonly.appcreateddata'
      ]
    )
    auth_uri = @auth_client.authorization_uri.to_s
    redirect auth_uri
  end

  get '/redirect' do
    @auth_client.code = request['code']
    @auth_client.fetch_access_token!
    auth_client = Signet::OAuth2::Client.new(JSON.parse(@auth_client.to_json))
    session[:token] = auth_client.access_token
    redirect '/list'
  end

  get '/list' do
    uri = URI.parse 'https://photoslibrary.googleapis.com/v1/albums'
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true
    req = Net::HTTP::Get.new uri.request_uri
    req['Content-type'] = 'application/json'
    req['Authorization'] = "Bearer #{session[:token]}"
    res = http.request req
    # "<pre>#{JSON.pretty_generate(JSON.parse(res.body))}</pre>"
    @albums = JSON.parse(res.body)
    erb :list
  end

  get '/:album_id/list' do
    uri = URI.parse 'https://photoslibrary.googleapis.com/v1/mediaItems:search'
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true
    req = Net::HTTP::Post.new uri.request_uri
    req['Content-type'] = 'application/json'
    req['Authorization'] = "Bearer #{session[:token]}"
    req.body = { 
      "pageSize" => "100",
      "albumId" => params['album_id']
    }.to_json
    res = http.request req
    @media_items = JSON.parse(res.body)
    erb :items
  end
end
```



```
mkdir views

nano views/list.erb
```


views/list.erb

```ruby
<html>
  <head>
    <title>test web app</title>
  </head>
  <body>
    <h1>アルバム</h1>
    <ul>
      <% @albums['albums'].each do |album| %>
        <li><a href="/<%= album['id'] %>/list"><%= album['title'] %></a></li>
      <% end %>
    </ul>
  </body>
</html>
```


```bash
nano views/items.erb
```

views/items.erb


```ruby
<html>
  <head>
    <title>test web app</title>
  </head>
  <body>
    <h1>写真一覧</h1>
    <ul>
      <% @media_items['mediaItems'].each do |item| %>
        <li><a href="<%= item['productUrl'] %>" target="_blank"><%= item['filename'] %></a></li>
      <% end %>
    </ul>
  </body>
</html>
```


## 実行

webサーバを起動  port 9292

```bash
bundle exec rackup config.ru
```

## ブラウザで確認


開発マシンでブラウザを開いて、自分のサイトに接続

```url
http://localhost:9292 
```

アプリが使用する権限が表示されるので「許可」

最初にアルバムの一覧が表示されます
