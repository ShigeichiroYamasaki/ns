# ネットワークセキュリティ演習
## 6回 サイバー攻撃と脆弱性

## CVE (Common Vulnerabilities and Exposures) データベース

CVEのサイト

[CVE](http://cve.mitre.org)

CVEは、CVE番号で管理名をつけている

* CVE-2014-0160 を検索してみる


より詳細の情報は、NISTの(NVD)にある

（Learn more at National Vulnerability Database (NVD)）をクリックする

* NVD の例

[CVE-2014-0160](https://nvd.nist.gov/vuln/detail/CVE-2014-0160)

### CVSS (共通脆弱性評価システム）

NVD のデータで評価値を調べてみる

### IPA のCVE情報

[IPA CVE](https://www.ipa.go.jp/security/announce/alert.html)

* IPAが公開している脆弱性情報を確認してください
* １件、レポートに入れてください

### IPAへの届け出・相談・情報提供

[https://www.ipa.go.jp/security/outline/todoke-top-j.html](https://www.ipa.go.jp/security/outline/todoke-top-j.html)


## C言語

各自自分の演習マシンにログインしてください

### C言語の配列

```bash
nano array.c
```

```c
#include <stdio.h>
int main(){
  int a[3]; /* 整数の３項の配列 */
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a[0]=%d\n",a[0]);
  printf("a[1]=%d\n",a[1]);
  printf("a[2]=%d\n",a[2]);
  return 0;
}
```

コンパイル

```bash
gcc array.c
```

実行

```bash
./a.out 
```



### ポインタとしての配列

```bash
nano parray.c
```

```c
#include <stdio.h>
int main(){
  int a[3];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a=%p\n",a);
  return 0;
}

```

コンパイル

```bash
gcc parray.c
```

実行

```bash
./a.out 
```

### 配列変数aは、ポインタ

配列要素はそれぞれ変数になっている

```bash
nano parray2.c
```


```c
#include <stdio.h>
int main(){
  int a[3];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a=%p\n",a);
  printf("&a[0]=%p\n",&a[0]);
  printf("&a[1]=%p\n",&a[1]);
  printf("&a[2]=%p\n",&a[2]);
  return 0;
}
```

コンパイル

```bash
gcc parray2.c
```

実行

```bash
./a.out 
```


### ポインタへの加算


```bash
nano parray3.c
```

```c
#include <stdio.h>
int main(){
  int a[3];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a=%p\n",a);
  printf("a+1=%p\n",a+1);
  printf("a+2=%p\n",a+2);
  return 0;
}
```

コンパイル

```bash
gcc parray3.c
```

実行

```bash
./a.out 
```

ポインタ演算子で参照先にアクセス

```bash
nano parray3.c
```

```c
#include <stdio.h>
int main(){
  int a[3];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a=%p\n",a);
  printf("a+1=%p\n",a+1);
  printf("a+2=%p\n",a+2);
  printf("*a=%d\n",*a);
  printf("*(a+1)=%d\n",*(a+1));
  printf("*(a+2)=%d\n",*(a+2));  
  return 0;
}
```

コンパイル

```bash
gcc parray3.c
```

実行

```bash
./a.out 
```

### ポインタとしての配列


```bash
nano parray4.c
```


```c
#include <stdio.h>
int main(){
  int a[3];
  int *p;
  p=&a[0];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("*p=%d\n",*p);
  return 0;
}

```

```bash
gcc parray4.c
./a.out
```


### C言語の文字列は文字の配列

```bash
nano chars.c
```

```c
#include <stdio.h>
int main(){
  char *aisatu;
  aisatu="hello";
  printf("%s\n",aisatu);
  return 0;
}
```

コンパイル

```bash
gcc chars.c
```

実行

```bash
./a.out 
```

```bash
nano chars.c
```

```c
#include <stdio.h>
int main(){
  char *aisatu;
  aisatu="hello";
  printf("%s\n",aisatu);
  printf("%c\n",*(aisatu));
  printf("%c\n",*(aisatu+1));
  printf("%c\n",*(aisatu+2));
  return 0;
}
```

コンパイル

```bash
gcc chars.c
```

実行

```bash
./a.out 
```



### ポインタのコピー


```bash
nano chars2.c
```

```c
#include <stdio.h>
int main(){
  char *aisatu;
  char *greeting;
  aisatu="hello";
  greeting=aisatu;
  printf("%s\n",greeting);
  printf("%p\n",greeting);
  return 0;
}
```

コンパイル

```bash
gcc chars.c
```

実行

```bash
./a.out 
```

### ポインタのポインタ

```bash
nano pointerpointer.c
```


```c
#include <stdio.h>
int main(void){
    int a = 0;
    int *p;   /*整数へのポインタ*/
    int **pp; /*整数へのポインタのポインタ*/
    p=&a;
    pp=&p;
    printf("**pp=%d\n", **pp);
    return 0;
}
```

```bash
gcc pointerpointer.c

./a.out
```


## メモリマップを調べる

### Linuxの仮想記憶空間

```
+------------------------------+  0x0000000000000000
:                              :
+------------------------------+
|                              |
|  .text                       |  ELF                             |
|                              |
+------------------------------+
|                              |
|  heap                        |  malloc() で動的に確保される領域(上位アドレスに伸びる)
|                              |
+------------------------------+
|            ↓                 |
:                              :
:                              :
|                              |
+------------------------------+
|                              |
|  shared memory               |  共有メモリ領域
|                              |
+------------------------------+
|                              |
:                              :
:                              :
|             ↑                |
+------------------------------+
|                              |
|  stack                       |  関数呼び出しやローカル変数等で使用されるスタック領域(下位アドレスに伸びる)
|                              |
+------------------------------+
|                              |
|  arguments / environments    |  引数と環境変数
|                              |
+------------------------------+
:                              :
:                              :
+------------------------------+  0xffffffffffffffff = 2^64 (64bit の場合)
```


### メモリマップの調べ方


#### プロセスIDのを調べる

```bash
ps -ef
```

sshd のプロセスIDを調べたい場合

```bash
ps -ef|grep sshd

root       985     1  0 10月22 ?      00:00:00 /usr/sbin/sshd -D
root      9712   985  0 10月26 ?      00:00:00 sshd: yamalabo [priv]
yamalabo  9806  9712  0 10月26 ?      00:00:01 sshd: yamalabo@pts/2
yamalabo 15213  9807  0 08:46 pts/2    00:00:00 grep sshd
```

sshd のPIDは 9807 だということがわかる

#### pmap コマンドでメモリマップを調べる


sshd のメモリマップを調べる

```bash
sudo pmap -x 9807
```

sleepコマンドでプロセスを生成し、そのプロセスIDでメモリマップを調べる

```bash
sleep 10000 &
[1] 42845

sudo pmap -x 42845
```

## ASLR の無効化

```bash
sudo sysctl -w kernel.randomize_va_space=0
```
	
★必ず最後にまた有効化する

有効化の方法

```bash
sudo sysctl -w kernel.randomize_va_space=2
```

## バイナリ解析ツール

file コマンド
readelf　コマンド
strings コマンド
grep コマンド
strace コマンド
ltrace コマンド
gdb
radare2

### インストール

```bash
sudo apt update
sudo apt upgrade -y

sudo apt install gdb -y
sudo apt install radare2 -y

```

### file コマンド

ファイル形式を確認する


```bash
file integet.c
file a.out
file /bin/ls
```

### readelf　コマンド(実行可能ファイルの解析）

ELFの表示
ELFはExecutable and Linkable Formatの略
オブジェクトファイルや実行ファイルの中身を解析できる

```bash
readelf -h a.out
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              DYN (Shared object file)
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x540
  Start of program headers:          64 (bytes into file)
  Start of section headers:          32824 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           56 (bytes)
  Number of program headers:         9
  Size of section headers:           64 (bytes)
  Number of section headers:         35
  Section header string table index: 34

```

```bash
readelf -a a.out
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              DYN (Shared object file)
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x540
  Start of program headers:          64 (bytes into file)
  Start of section headers:          32824 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           56 (bytes)
  Number of program headers:         9
  Size of section headers:           64 (bytes)
  Number of section headers:         35
  Section header string table index: 34

...
Displaying notes found in: .note.gnu.build-id
  Owner                 Data size	Description
  GNU                  0x00000014	NT_GNU_BUILD_ID (unique build ID bitstring)
    Build ID: 67f1ce1e6e5762b5deb6437ba254a2c15ff45735
    
```

### strings コマンド

バイナリファイルの中身を確認する

```bash
strings a.out |grep printf

strings  a.out
```

### strace コマンド

プロセスが呼び出すシステムコールをトレースする


```bash
strace /bin/ls

```

### ltrace コマンド

プロセスが呼び出すライブラリ関数をトレースする


```bash
ltrace /bin/ls
```

### gdb

C言語のデバッガ

* ブレークポイントの設定
* ステップ実行
* 変数の中身を覗く
* 変数の中身を書き換える

```bash
gcc -g3 integer.c
```

```bash
gdb a.out hello
```

```gdb
break main

run

step

step

quit
```


