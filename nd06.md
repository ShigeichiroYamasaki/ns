# ネットワークセキュリティ演習
## 6回 サイバー攻撃と脆弱性(ファイアーウォールの続き)

* [レポート](https://forms.gle/fW76GP4YJJgzFybh8)


## ファイアーウォール用スクリプトの作成


毎回設定コマンドを入力するのは現実的でないので、代わりにシェルスクリプトを作成する

## 方針

### mailサーバをSSHサーバにする

* sshd はすでにインストール済
* IPアドレスは、172.16.0.2
* ssh のポート番号は 22

## 事前チェック


事前にネットワーク・インターフェース名を確認する

```bash
ip addr
```

* グローバル側インタフェース名：enpXXX のような名前
* ルータのグローバル側のIPアドレス


## FWルータ１


### シェルスクリプトファイルの作成

```
cd ~
nano fw1.sh
```


```bash
#!/bin/bash

# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X

# IP MASQUERADE
sudo iptables -t nat -A POSTROUTING -o <グローバル側インタフェース名>　-j MASQUERADE

# http へのDNAT
sudo iptables -t nat -A PREROUTING -i <グローバル側インタフェース名>　-p tcp --dport 80 -j DNAT --to 172.16.0.1:80
```


### FWルータ２

```
cd ~
nano fw2.sh
```


```bash
#!/bin/bash
# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X

# IP MASQUERADE
sudo iptables -t nat -A POSTROUTING -o <グローバル側インタフェース名>-j MASQUERADE
```

## FW1ルータでの確認

DNS, web, ssh などができることを確認
ssh は、fw2や外部PCにsshログインできる


## ポリシーの作成例

### ポート開放の基本方針

* http をACCEPT
* 同じ班からの ssh をACCEPT
* 他の班からのsshはDROP

### デフォルト否定

FWルータのルールの最後に以下を設定

* INPUT	チェーンはすべて DROP
* FOWARD チェーンはすべてDROP
* OUTPUT チェーンはすべてACCETP

## FW1 のINPUTを全部制限してみる

FW1ルータ

```
cd ~
nano fw1.sh
```


```bash
#!/bin/bash
#!/bin/bash

# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X

# IP MASQUERADE
sudo iptables -t nat -A POSTROUTING -o <グローバル側インタフェース名>　-j MASQUERADE

# http へのDNAT
sudo iptables -t nat -A PREROUTING -i <グローバル側インタフェース名>　-p tcp --dport 80 -j DNAT --to 172.16.0.1:80

# INPUTチェーンの制限
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -j DROP

```


### 過剰制限になっていることの確認

DNS, web, ssh などすべての操作ができなくなっている


```bash
dig
```

応答がない

### DNSを通過させるようにする


53番ポート
UDPとTCPの両方があることに注意

```
cd ~
nano fw1.sh
```


```bash
#!/bin/bash
#!/bin/bash

# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X

# IP MASQUERADE
sudo iptables -t nat -A POSTROUTING -o <グローバル側インタフェース名>　-j MASQUERADE

# http へのDNAT
sudo iptables -t nat -A PREROUTING -i <グローバル側インタフェース名>　-p tcp --dport 80 -j DNAT --to 172.16.0.1:80

# INPUTチェーンの制限
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 53 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p udp --sport 53 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -j DROP

```

```bash
dig
```

応答が返ってくる


### http https ssh を空ける


```
cd ~
nano fw1.sh
```


```bash
#!/bin/bash
#!/bin/bash

# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X

# IP MASQUERADE
sudo iptables -t nat -A POSTROUTING -o <グローバル側インタフェース名>　-j MASQUERADE

# http へのDNAT
sudo iptables -t nat -A PREROUTING -i <グローバル側インタフェース名>　-p tcp --dport 80 -j DNAT --to 172.16.0.1:80

# INPUTチェーンの制限
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 80 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 22 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 443 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 53 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p udp --sport 53 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -j DROP

```

### FW1のFORWARDを制限してみる


まず、全パケットを転送しないように制限

```bash
#!/bin/bash
#!/bin/bash

# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X

# IP MASQUERADE
sudo iptables -t nat -A POSTROUTING -o <グローバル側インタフェース名>　-j MASQUERADE

# http へのDNAT
sudo iptables -t nat -A PREROUTING -i <グローバル側インタフェース名>　-p tcp --dport 80 -j DNAT --to 172.16.0.1:80

# INPUTチェーンの制限
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 80 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 22 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 443 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 53 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p udp --sport 53 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -j DROP

# FORWARDチェーンの制限
sudo iptables -A FORWARD -i <グローバル側インタフェース名> -j DROP

```

#### DMZから外のDNS, web, sshが見えるようにする


```bash
#!/bin/bash
#!/bin/bash

# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X

# IP MASQUERADE
sudo iptables -t nat -A POSTROUTING -o <グローバル側インタフェース名>　-j MASQUERADE

# http へのDNAT
sudo iptables -t nat -A PREROUTING -i <グローバル側インタフェース名>　-p tcp --dport 80 -j DNAT --to 172.16.0.1:80

# INPUTチェーンの制限
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 80 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 22 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 443 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 53 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p udp --sport 53 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -j DROP

# FORWARDチェーンの制限
sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p tcp --sport 80 -j ACCPET
sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p tcp --sport 22 -j ACCPET
sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p tcp --sport 443 -j ACCPET
sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p tcp --sport 53 -j ACCPET
sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p udp --sport 53 -j ACCPET
sudo iptables -A FORWARD -i <グローバル側インタフェース名> -j DROP

```

#### 外からDMZのweb, sshが見えるようにする


```bash
#!/bin/bash
#!/bin/bash

# 設定の初期化
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X

# IP MASQUERADE
sudo iptables -t nat -A POSTROUTING -o <グローバル側インタフェース名>　-j MASQUERADE

# http へのDNAT
sudo iptables -t nat -A PREROUTING -i <グローバル側インタフェース名>　-p tcp --dport 80 -j DNAT --to 172.16.0.1:80

# INPUTチェーンの制限
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 80 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 22 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 443 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p tcp --sport 53 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -p udp --sport 53 -j ACCPET
sudo iptables -A INPUT -i  <グローバル側インタフェース名> -j DROP

# FORWARDチェーンの制限
sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p tcp --dport 80 -j ACCPET
sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p tcp --dport 22 -j ACCPET

sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p tcp --sport 80 -j ACCPET
sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p tcp --sport 22 -j ACCPET
sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p tcp --sport 443 -j ACCPET
sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p tcp --sport 53 -j ACCPET
sudo iptables -A FORWARD -i  <グローバル側インタフェース名> -p udp --sport 53 -j ACCPET
sudo iptables -A FORWARD -i <グローバル側インタフェース名> -j DROP

```


### 各班で設定を考えてみる

* 自分の班の外部PCからはSSHできる
* 他の班のPCからはSSHできないことを確認する

* 他の班のSSHサーバにアクセスできると加点する


## CVE (Common Vulnerabilities and Exposures) データベース

CVEのサイト

[CVE](http://cve.mitre.org)

CVEは、CVE番号で管理名をつけている

* CVE-2014-0160 を検索してみる
*

より詳細の情報は、NISTの(NVD)にある

（Learn more at National Vulnerability Database (NVD)）をクリックする

* NVD の例

[CVE-2014-0160](https://nvd.nist.gov/vuln/detail/CVE-2014-0160)

### CVSS (共通脆弱性評価システム）

NVD のデータで評価値を調べてみる

### IPA のCVE情報

[IPA CVE](https://www.ipa.go.jp/security/announce/alert.html)

* IPAが公開している脆弱性情報を確認してください
* １件、レポートに入れてください

## バイナリ解析ツール

file コマンド
readelf　コマンド
strings コマンド
grep コマンド
strace コマンド
ltrace コマンド
gdb
radare2


### file コマンド

ファイル形式を確認する


```bash
file /bin/ls
```

### readelf　コマンド

ELFの表示
ELFはExecutable and Linkable Formatの略
オブジェクトファイルや実行ファイルの

```bash
readelf –e  /bin/ls
```

### strings コマンド

バイナリファイルの中身を確認する

```bash
strings  /bin/ls
```

### strace コマンド

プロセスが呼び出すシステムコールをトレースする


```bash
strace /bin/ls

```

### ltrace コマンド

プロセスが呼び出すライブラリ関数をトレースする


```bash
ltrace /bin/ls
```

### gdb

C言語のデバッガ

* ブレークポイントの設定
* ステップ実行
* 変数の中身を覗く
* 変数の中身を書き換える



### C言語の配列

```bash
nano array.c
```

```c
#include <stdio.h>
int main(){
  int a[3]; /* 整数の３項の配列 */
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a[0]=%d\n",a[0]);
  printf("a[1]=%d\n",a[1]);
  printf("a[2]=%d\n",a[2]);
  return 0;
}
```

コンパイル

```bash
gcc array.c
```

実行

```bash
./a.out 
```
## file コマンド

```bash
file a.out 
```

## gdbコマンド

```bash
gdb a.out
```




### ポインタとしての配列

```bash
nano parray.c
```

```c
#include <stdio.h>
int main(){
  int a[3];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a=%p\n",a);
  return 0;
}

```

コンパイル

```bash
gcc parray.c
```

実行

```bash
./a.out 
```

### 配列変数aは、ポインタ

配列要素はそれぞれ変数になっている

```bash
nano parray2.c
```


```c
#include <stdio.h>
int main(){
  int a[3];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a=%p\n",a);
  printf("&a[0]=%p\n",&a[0]);
  printf("&a[1]=%p\n",&a[1]);
  printf("&a[2]=%p\n",&a[2]);
  return 0;
}
```

コンパイル

```bash
gcc parray2.c
```

実行

```bash
./a.out 
```


### ポインタへの加算


```bash
nano parray3.c
```

```c
#include <stdio.h>
int main(){
  int a[3];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a=%p\n",a);
  printf("a+1=%p\n",a+1);
  printf("a+2=%p\n",a+2);
  return 0;
}
```

コンパイル

```bash
gcc parray3.c
```

実行

```bash
./a.out 
```

ポインタ演算子で参照先にアクセス

```bash
nano parray3.c
```

```c
#include <stdio.h>
int main(){
  int a[3];
  a[0]=10;
  a[1]=20;
  a[2]=30;
  printf("a=%p\n",a);
  printf("a+1=%p\n",a+1);
  printf("a+2=%p\n",a+2);
  printf("*a=%d\n",*a);
  printf("*(a+1)=%d\n",*(a+1));
  printf("*(a+2)=%d\n",*(a+2));  
  return 0;
}
```

コンパイル

```bash
gcc parray3.c
```

実行

```bash
./a.out 
```




### C言語の文字列は文字の配列

```bash
nano chars.c
```

```c
#include <stdio.h>
int main(){
  char *aisatu;
  aisatu="hello";
  printf("%s\n",aisatu);
  return 0;
}
```

コンパイル

```bash
gcc chars.c
```

実行

```bash
./a.out 
```

```bash
nano chars.c
```

```c
#include <stdio.h>
int main(){
  char *aisatu;
  aisatu="hello";
  printf("%s\n",aisatu);
  printf("%c\n",*(aisatu));
  printf("%c\n",*(aisatu+1));
  printf("%c\n",*(aisatu+2));
  return 0;
}
```

コンパイル

```bash
gcc chars.c
```

実行

```bash
./a.out 
```



### ポインタのコピー


```bash
nano chars2.c
```

```c
#include <stdio.h>
int main(){
  char *aisatu;
  char *greeting;
  aisatu="hello";
  greeting=aisatu;
  printf("%s\n",greeting);
  printf("%p\n",greeting);
  return 0;
}
```

コンパイル

```bash
gcc chars.c
```

実行

```bash
./a.out 
```


